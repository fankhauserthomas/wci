<!DOCTYPE html>
<html>

<head>
    <title>Sortiergruppen Debug Test</title>
    <style>
        body {
            font-family: monospace;
            margin: 20px;
        }

        .test-result {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }

        .success {
            background-color: #e8f5e8;
        }

        .failure {
            background-color: #ffebee;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
        }

        #testResults {
            max-height: 400px;
            overflow-y: auto;
        }

        .stats {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <h1>Sortiergruppen Debug Test</h1>
    <p>Teste ob HP-Daten und Sortiergruppen zuverlässig geladen werden</p>

    <button onclick="runSingleTest()">Einzeltest</button>
    <button onclick="runMultipleTests()">10x Test</button>
    <button onclick="clearResults()">Löschen</button>

    <div class="stats" id="stats">
        <strong>Statistik:</strong><br>
        Tests: <span id="totalTests">0</span><br>
        Erfolg: <span id="successTests">0</span><br>
        Fehler: <span id="failureTests">0</span><br>
        Erfolgsrate: <span id="successRate">0%</span>
    </div>

    <div id="testResults"></div>

    <script>
        let testCount = 0;
        let successCount = 0;
        let failureCount = 0;

        function updateStats() {
            document.getElementById('totalTests').textContent = testCount;
            document.getElementById('successTests').textContent = successCount;
            document.getElementById('failureTests').textContent = failureCount;
            document.getElementById('successRate').textContent = testCount > 0 ? Math.round((successCount / testCount) * 100) + '%' : '0%';
        }

        async function runSingleTest() {
            testCount++;
            const startTime = Date.now();

            try {
                // Simuliere Seitenladen durch API-Calls
                const timestamp = Date.now();

                const [dataResponse, hpDataResponse] = await Promise.all([
                    fetch(`data.php?date=2025-09-03&type=arrival&_t=${timestamp}`),
                    fetch(`reservierungen/api/get-all-hp-data.php?date=2025-09-03&type=arrival&_t=${timestamp}`)
                ]);

                const [mainData, hpData] = await Promise.all([
                    dataResponse.json(),
                    hpDataResponse.json()
                ]);

                const duration = Date.now() - startTime;

                // Analysiere Ergebnisse
                const mainDataValid = Array.isArray(mainData) && mainData.length > 0;
                const hpDataValid = hpData.success && Array.isArray(hpData.data) && hpData.data.length > 0;

                const mainIds = mainDataValid ? mainData.map(r => r.id) : [];
                const hpIds = hpDataValid ? hpData.data.map(item => item.res_id) : [];

                const matchingIds = mainIds.filter(id => hpIds.includes(id));
                const sortGroupCount = hpDataValid ? hpData.data.filter(item => item.sort_group).length : 0;

                const success = mainDataValid && hpDataValid && matchingIds.length > 0 && sortGroupCount > 0;

                if (success) {
                    successCount++;
                } else {
                    failureCount++;
                }

                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${success ? 'success' : 'failure'}`;
                resultDiv.innerHTML = `
                    <strong>Test #${testCount} - ${success ? '✅ ERFOLG' : '❌ FEHLER'} (${duration}ms)</strong><br>
                    Hauptdaten: ${mainData.length || 0} Einträge<br>
                    HP-Daten: ${hpData.data ? hpData.data.length : 0} Einträge<br>
                    Matching IDs: ${matchingIds.length}<br>
                    Sortiergruppen: ${sortGroupCount}<br>
                    Details: Main=${mainDataValid}, HP=${hpDataValid}, Match=${matchingIds.length > 0}, Sort=${sortGroupCount > 0}
                `;

                document.getElementById('testResults').appendChild(resultDiv);
                updateStats();

                // Auto-scroll
                resultDiv.scrollIntoView();

            } catch (error) {
                failureCount++;
                testCount--;

                const resultDiv = document.createElement('div');
                resultDiv.className = 'test-result failure';
                resultDiv.innerHTML = `
                    <strong>Test #${testCount + 1} - NETZWERK FEHLER</strong><br>
                    Fehler: ${error.message}
                `;
                document.getElementById('testResults').appendChild(resultDiv);
                updateStats();
            }
        }

        async function runMultipleTests() {
            for (let i = 0; i < 10; i++) {
                await runSingleTest();
                await new Promise(resolve => setTimeout(resolve, 500)); // 500ms Pause
            }
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            testCount = 0;
            successCount = 0;
            failureCount = 0;
            updateStats();
        }

        // Initial stats update
        updateStats();
    </script>
</body>

</html>
