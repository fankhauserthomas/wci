<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Test - Debug Version</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }

        .info {
            color: blue;
        }

        .debug {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .timeline-container {
            border: 1px solid #ddd;
            height: 400px;
            margin: 20px 0;
            position: relative;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>Timeline Test Page</h1>

    <div class="controls">
        <label>Von: <input type="date" id="startDate"></label>
        <label>Bis: <input type="date" id="endDate"></label>
        <button onclick="testLoadData()">Test API</button>
        <button onclick="testCanvas()">Test Canvas</button>
        <button onclick="showDebugInfo()">Debug Info</button>
    </div>

    <div id="status" class="debug">Status: Bereit</div>

    <div class="timeline-container" id="timeline-container">
        <!-- Timeline wird hier gerendert -->
    </div>

    <div id="debug-output" class="debug"></div>

    <script>
        // Test-Variablen
        let testReservations = [];
        let testRoomDetails = [];
        let testRooms = [];

        // Datum-Reset
        function resetDates() {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 7);
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 30);

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        }

        // Test API-Verbindung
        async function testLoadData() {
            const status = document.getElementById('status');
            const debugOutput = document.getElementById('debug-output');

            try {
                status.innerHTML = '<span class="info">üîÑ Teste API-Verbindung...</span>';

                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                // Test 1: Zimmer laden
                const roomsResponse = await fetch('getRooms.php');
                const roomsResult = await roomsResponse.json();

                debugOutput.innerHTML += `<h3>Zimmer-API Test:</h3>`;
                debugOutput.innerHTML += `<pre>${JSON.stringify(roomsResult, null, 2)}</pre>`;

                if (roomsResult.success) {
                    testRooms = roomsResult.data || [];
                    debugOutput.innerHTML += `<p class="success">‚úÖ ${testRooms.length} Zimmer erfolgreich geladen</p>`;
                } else {
                    debugOutput.innerHTML += `<p class="error">‚ùå Zimmer-API Fehler: ${roomsResult.error}</p>`;
                }

                // Test 2: Zimmerplan-Daten laden
                const dataResponse = await fetch(`getZimmerplanData.php?start=${startDate}&end=${endDate}`);
                const dataResult = await dataResponse.json();

                debugOutput.innerHTML += `<h3>Zimmerplan-API Test:</h3>`;
                debugOutput.innerHTML += `<pre>${JSON.stringify(dataResult, null, 2).substring(0, 1000)}...</pre>`;

                if (dataResult.success) {
                    testReservations = dataResult.data.timeline_items || [];
                    testRoomDetails = dataResult.data.room_details || [];

                    debugOutput.innerHTML += `<p class="success">‚úÖ Zimmerplan-Daten erfolgreich geladen:</p>`;
                    debugOutput.innerHTML += `<ul>`;
                    debugOutput.innerHTML += `<li>Timeline Items: ${testReservations.length}</li>`;
                    debugOutput.innerHTML += `<li>Room Details: ${testRoomDetails.length}</li>`;
                    debugOutput.innerHTML += `</ul>`;
                } else {
                    debugOutput.innerHTML += `<p class="error">‚ùå Zimmerplan-API Fehler: ${dataResult.error}</p>`;
                }

                status.innerHTML = '<span class="success">‚úÖ API-Tests abgeschlossen</span>';

            } catch (error) {
                status.innerHTML = `<span class="error">‚ùå API-Test fehlgeschlagen: ${error.message}</span>`;
                debugOutput.innerHTML += `<p class="error">Fehler: ${error.message}</p>`;
                debugOutput.innerHTML += `<pre>${error.stack}</pre>`;
            }
        }

        // Test Canvas-Rendering
        async function testCanvas() {
            const container = document.getElementById('timeline-container');
            const status = document.getElementById('status');

            try {
                status.innerHTML = '<span class="info">üîÑ Teste Canvas-Rendering...</span>';

                // Lade Timeline-Unified.js dynamisch
                if (typeof TimelineUnifiedRenderer === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'timeline-unified.js';
                    script.onload = () => {
                        initCanvas();
                    };
                    script.onerror = () => {
                        status.innerHTML = '<span class="error">‚ùå timeline-unified.js konnte nicht geladen werden</span>';
                    };
                    document.head.appendChild(script);
                } else {
                    initCanvas();
                }

                function initCanvas() {
                    container.innerHTML = '';

                    const renderer = new TimelineUnifiedRenderer(container);

                    // Test mit Demo-Daten falls keine echten Daten
                    if (testReservations.length === 0) {
                        generateTestData();
                    }

                    renderer.updateData(testReservations, testRoomDetails, testRooms);

                    status.innerHTML = '<span class="success">‚úÖ Canvas erfolgreich initialisiert</span>';
                }

            } catch (error) {
                status.innerHTML = `<span class="error">‚ùå Canvas-Test fehlgeschlagen: ${error.message}</span>`;
                console.error('Canvas-Fehler:', error);
            }
        }

        // Generiere Test-Daten
        function generateTestData() {
            const today = new Date();

            testRooms = [
                { id: 1, caption: 'Test Zimmer 1', capacity: 2, display_name: 'Test Zimmer 1 (2P)' },
                { id: 2, caption: 'Test Zimmer 2', capacity: 4, display_name: 'Test Zimmer 2 (4P)' },
                { id: 3, caption: 'Test Zimmer 3', capacity: 3, display_name: 'Test Zimmer 3 (3P)' }
            ];

            testReservations = [
                {
                    id: 1,
                    name: 'Test, Gast',
                    capacity: 2,
                    arrangement: '√úF',
                    start: new Date(today.getTime() + 1 * 24 * 60 * 60 * 1000),
                    end: new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000),
                    data: { is_disposed: false }
                },
                {
                    id: 2,
                    name: 'Demo, User',
                    capacity: 4,
                    arrangement: 'HP',
                    start: new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000),
                    end: new Date(today.getTime() + 5 * 24 * 60 * 60 * 1000),
                    data: { is_disposed: true }
                }
            ];

            testRoomDetails = [
                {
                    id: 1,
                    room_id: 1,
                    guest_name: 'Test, Gast',
                    start: new Date(today.getTime() + 1 * 24 * 60 * 60 * 1000),
                    end: new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000),
                    color: '#3498db',
                    arrangement: '√úF',
                    capacity: 2
                }
            ];
        }

        // Debug-Informationen anzeigen
        function showDebugInfo() {
            const debugOutput = document.getElementById('debug-output');

            debugOutput.innerHTML = `
                <h3>Debug Informationen:</h3>
                <ul>
                    <li>Timeline-Unified.js geladen: ${typeof TimelineUnifiedRenderer !== 'undefined' ? '‚úÖ' : '‚ùå'}</li>
                    <li>Test Reservierungen: ${testReservations.length}</li>
                    <li>Test Zimmer-Details: ${testRoomDetails.length}</li>
                    <li>Test Zimmer: ${testRooms.length}</li>
                    <li>Browser: ${navigator.userAgent}</li>
                    <li>Canvas-Support: ${!!document.createElement('canvas').getContext ? '‚úÖ' : '‚ùå'}</li>
                </ul>
                
                <h4>Console Logs:</h4>
                <p>√ñffne die Browser-Konsole (F12) f√ºr detaillierte Logs</p>
            `;
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', () => {
            resetDates();
            showDebugInfo();
        });
    </script>
</body>

</html>