<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Unified - Single Canvas Rendering</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls input[type="date"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .controls button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .controls button:hover {
            background: #0056b3;
        }

        .controls button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .main-areas-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            height: 740px;
        }

        .status-info {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
        }

        .timeline-unified-container {
            position: relative !important;
        }

        .scroll-horizontal::-webkit-scrollbar,
        .scroll-vertical::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .scroll-horizontal::-webkit-scrollbar-track,
        .scroll-vertical::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .scroll-horizontal::-webkit-scrollbar-thumb,
        .scroll-vertical::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
        }

        .scroll-horizontal::-webkit-scrollbar-thumb:hover,
        .scroll-vertical::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .performance-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Timeline Unified Renderer</h1>
        <p>Radikaler Umbau: Alles auf einer Canvas-Fl√§che f√ºr maximale Performance</p>

        <div class="controls">
            <label>Von: <input type="date" id="startDate"></label>
            <label>Bis: <input type="date" id="endDate"></label>
            <button onclick="loadRealData()">Daten laden</button>
            <button onclick="generateDemoData()">Demo-Daten</button>
            <button onclick="toggleDisposedReservations()" id="toggle-disposed-btn">Disponierte ausblenden</button>

            <label>Zoom:
                <select id="zoom-select" onchange="changeZoom()">
                    <option value="40">50%</option>
                    <option value="60">75%</option>
                    <option value="80" selected>100%</option>
                    <option value="100">125%</option>
                    <option value="120">150%</option>
                </select>
            </label>
        </div>

        <div class="status-info" id="status-info">Bereit zum Laden von Daten</div>
    </div>

    <div class="main-areas-container"></div>

    <div class="performance-info" id="performance-info">
        FPS: <span id="fps">0</span><br>
        Render Zeit: <span id="render-time">0ms</span><br>
        Reservierungen: <span id="reservations-count">0</span><br>
        Zimmer: <span id="rooms-count">0</span>
    </div>

    <!-- Scripts -->
    <script src="timeline-unified.js"></script>
    <script>
        // ===== FUNCTION DEFINITIONS (moved to top for onclick availability) =====

        // Echte Daten laden (API-Integration)
        async function loadRealData() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                if (!startDate || !endDate) {
                    alert('Bitte Start- und End-Datum ausw√§hlen');
                    return;
                }

                console.log('Loading REAL data from API...');
                document.getElementById('status-info').innerHTML =
                    '<span style="color: #007bff;">üîÑ Lade echte Daten von API...</span>';

                // API-Aufruf f√ºr echte Daten
                const response = await fetch(`getZimmerplanData.php?start=${startDate}&end=${endDate}`);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                if (!result.success) {
                    throw new Error(result.error || 'API-Fehler');
                }

                console.log('API Response:', result);

                // Verarbeite Reservierungen (Master Timeline)
                reservations = result.data.timeline_items
                    ? result.data.timeline_items
                        .filter(item => item.content && item.start && item.end)
                        .map((item, index) => ({
                            id: item.id || index,
                            name: item.data ? item.data.guest_name : item.content.replace(/<[^>]*>/g, ''),
                            nachname: item.data ? item.data.guest_name.split(' ')[0] : '',
                            vorname: item.data ? item.data.guest_name.split(' ').slice(1).join(' ') : '',
                            start: parseAPIDate(item.start),
                            end: parseAPIDate(item.end),
                            capacity: item.data ? item.data.capacity : 1,
                            fullData: item.data
                        }))
                    : [];

                // Verarbeite Zimmer-Details
                roomDetails = result.data.room_details
                    ? result.data.room_details
                        .filter(item => item.room_id && item.start && item.end)
                        .map(item => ({
                            room_id: item.room_id,
                            guest_name: item.data ? item.data.guest_name : 'Unbekannt',
                            start: parseAPIDate(item.start),
                            end: parseAPIDate(item.end),
                            color: item.data ? item.data.color : '#3498db',
                            has_dog: item.data ? item.data.has_dog : false,
                            capacity: item.data ? item.data.capacity : 1,
                            data: item.data || {}
                        }))
                    : [];

                // Lade Zimmer-Daten
                const roomsResponse = await fetch('getRooms.php');
                const roomsResult = await roomsResponse.json();

                if (roomsResult.success) {
                    rooms = roomsResult.data || [];
                    // Sortiere Zimmer f√ºr konsistente Anzeige
                    rooms.sort((a, b) => {
                        const sortA = a.sort !== undefined ? a.sort : a.id;
                        const sortB = b.sort !== undefined ? b.sort : b.id;
                        return sortA - sortB;
                    });
                } else {
                    console.warn('Failed to load rooms, using fallback');
                    rooms = [
                        { id: 1, caption: 'Zimmer 1', capacity: 2, display_name: 'Zimmer 1 (2P)' },
                        { id: 2, caption: 'Zimmer 2', capacity: 4, display_name: 'Zimmer 2 (4P)' },
                        { id: 3, caption: 'Zimmer 3', capacity: 3, display_name: 'Zimmer 3 (3P)' }
                    ];
                }

                console.log(`Loaded REAL data: ${reservations.length} reservations, ${roomDetails.length} room details, ${rooms.length} rooms`);

                // Debug-Info
                const disposedCount = reservations.filter(r => r.data && r.data.is_disposed).length;
                const undisposedCount = reservations.filter(r => r.data && !r.data.is_disposed).length;
                console.log(`Disposition: ${disposedCount} disposed, ${undisposedCount} undisposed`);

                // Rendere Timeline mit echten Daten
                renderTimeline();

                document.getElementById('status-info').innerHTML =
                    `<span style="color: #28a745;">‚úÖ Echte Daten geladen: ${reservations.length} Reservierungen, ${rooms.length} Zimmer</span>`;

            } catch (error) {
                console.error('Fehler beim Laden der echten Daten:', error);
                document.getElementById('status-info').innerHTML =
                    `<span style="color: #dc3545;">‚ùå API-Fehler: ${error.message}</span>`;

                // Fallback zu Demo-Daten bei API-Fehler
                console.warn('Falling back to demo data due to API error');
                generateDemoData();
            }
        }

        // API-Datum-Parser (kompatibel mit getZimmerplanData.php)
        function parseAPIDate(dateString) {
            if (!dateString) return new Date();

            dateString = dateString.trim();

            // ISO-Format (YYYY-MM-DD oder YYYY-MM-DD HH:MM:SS)
            if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) {
                return new Date(dateString);
            }

            // Deutsches Format (DD.MM.YYYY)
            if (/^\d{1,2}\.\d{1,2}\.\d{4}/.test(dateString)) {
                const parts = dateString.split('.');
                if (parts.length >= 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    return new Date(year, month, day, 12, 0, 0, 0);
                }
            }

            return new Date(dateString);
        }

        // Demo-Daten Generator
        function generateDemoData() {
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);

            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 30);

            // Demo Zimmer
            rooms = [
                { id: 1, caption: 'Zimmer 1', capacity: 2, display_name: 'Zimmer 1 (2P)' },
                { id: 2, caption: 'Zimmer 2', capacity: 4, display_name: 'Zimmer 2 (4P)' },
                { id: 3, caption: 'Zimmer 3', capacity: 6, display_name: 'Zimmer 3 (6P)' },
                { id: 4, caption: 'Zimmer 4', capacity: 3, display_name: 'Zimmer 4 (3P)' },
                { id: 5, caption: 'Zimmer 5', capacity: 2, display_name: 'Zimmer 5 (2P)' },
            ];

            // Demo Reservierungen
            reservations = [];
            roomDetails = [];

            for (let i = 0; i < 50; i++) {
                const start = new Date(startDate);
                start.setDate(start.getDate() + Math.floor(Math.random() * 30));

                const end = new Date(start);
                end.setDate(end.getDate() + Math.floor(Math.random() * 7) + 1);

                const capacity = Math.floor(Math.random() * 8) + 1;
                const names = ['M√ºller', 'Schmidt', 'Weber', 'Wagner', 'Becker', 'Schulz', 'Hoffmann'];
                const firstNames = ['Hans', 'Anna', 'Peter', 'Maria', 'Klaus', 'Petra', 'Wolfgang'];

                const nachname = names[Math.floor(Math.random() * names.length)];
                const vorname = firstNames[Math.floor(Math.random() * firstNames.length)];

                const reservation = {
                    id: i,
                    name: `${nachname}, ${vorname}`,
                    nachname: nachname,
                    vorname: vorname,
                    capacity: capacity,
                    arrangement: ['HP', 'VP', '√úF', 'Selbstversorger'][Math.floor(Math.random() * 4)],
                    start: start,
                    end: end,
                    data: {
                        is_disposed: Math.random() > 0.8
                    }
                };

                reservations.push(reservation);

                // Zimmer-Details (50% der Reservierungen haben Zimmer zugewiesen)
                if (Math.random() > 0.5) {
                    const room = rooms[Math.floor(Math.random() * rooms.length)];
                    roomDetails.push({
                        id: i + 100,
                        room_id: room.id,
                        guest_name: `${nachname}, ${vorname}`,
                        start: start,
                        end: end,
                        color: ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6'][Math.floor(Math.random() * 5)],
                        has_dog: Math.random() > 0.8,
                        arrangement: reservation.arrangement,
                        capacity: capacity,
                        data: { room_name: room.caption }
                    });
                }
            }

            renderTimeline();

            document.getElementById('status-info').innerHTML =
                `<span style="color: #28a745;">Demo-Daten generiert: ${reservations.length} Reservierungen, ${roomDetails.length} Zimmerzuteilungen</span>`;
        }

        // Zoom-Funktion
        function changeZoom() {
            const zoom = parseInt(document.getElementById('zoom-select').value);
            if (timelineRenderer) {
                timelineRenderer.setDayWidth(zoom);
            }
        }

        // Disponierte Filter
        function toggleDisposedReservations() {
            showDisposedReservations = !showDisposedReservations;

            const button = document.getElementById('toggle-disposed-btn');
            button.textContent = showDisposedReservations ? 'Disponierte ausblenden' : 'Disponierte anzeigen';

            // Filter anwenden
            const filteredReservations = reservations.filter(r => {
                if (!showDisposedReservations && r.data && r.data.is_disposed) {
                    return false;
                }
                return true;
            });

            if (timelineRenderer) {
                timelineRenderer.updateData(filteredReservations, roomDetails, rooms);
            }
        }

        // Rendere Timeline (Canvas oder DOM) - FIXED: Pass selector string
        function renderTimeline() {
            if (timelineRenderer) {
                console.log('Rendering timeline with unified renderer...');
                timelineRenderer.updateData(reservations, roomDetails, rooms);
            } else {
                console.log('Creating new unified timeline renderer...');
                // FIXED: Pass selector string, not DOM element
                timelineRenderer = new TimelineUnifiedRenderer('.main-areas-container');
                timelineRenderer.updateData(reservations, roomDetails, rooms);
            }
        }

        // Datum-Reset
        function resetDates() {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 7);
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 30);

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        }

        // ===== INITIALIZATION AND PERFORMANCE MONITORING =====

        // Performance Monitoring
        let fps = 0;
        let lastFrame = performance.now();
        let frameCount = 0;

        function updatePerformanceInfo() {
            const now = performance.now();
            frameCount++;

            if (now - lastFrame >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFrame = now;

                document.getElementById('fps').textContent = fps;
                document.getElementById('reservations-count').textContent = reservations.length;
                document.getElementById('rooms-count').textContent = rooms.length;
            }

            requestAnimationFrame(updatePerformanceInfo);
        }
        updatePerformanceInfo();

        // ===== VARIABLES AND INITIALIZATION =====

        // Globale Variablen f√ºr Kompatibilit√§t mit timeline.js
        let showDisposedReservations = true;

        // WICHTIG: Variables bereits in timeline-unified.js deklariert als 'let'
        // Keine erneute Deklaration n√∂tig - verwende die globalen aus timeline-unified.js:
        // - reservations (bereits deklariert)
        // - roomDetails (bereits deklariert) 
        // - rooms (bereits deklariert)
        // - timelineRenderer (bereits deklariert)

        // Initialisierung
        document.addEventListener('DOMContentLoaded', () => {
            resetDates();

            // Automatisch echte Daten laden beim Seitenaufruf
            console.log('Auto-loading REAL data on page load...');
            document.getElementById('status-info').innerHTML =
                '<span style="color: #007bff;">üîÑ Automatisches Laden der echten Daten...</span>';

            // Versuche echte Daten zu laden, bei Fehler: Demo-Daten
            loadRealData().catch(error => {
                console.error('Auto-load failed, using demo data:', error);
                document.getElementById('status-info').innerHTML =
                    '<span style="color: #ffc107;">‚ö†Ô∏è API nicht erreichbar, verwende Demo-Daten</span>';
                generateDemoData();
            });

            // Debug-Funktionen global verf√ºgbar machen
            window.timelineDebugCanvas = {
                testDisposition: () => {
                    console.log('=== CANVAS DISPOSITION DATA TEST ===');
                    console.log('Total reservations:', reservations.length);

                    const disposedCount = reservations.filter(r => r.data && r.data.is_disposed === true).length;
                    const undisposedCount = reservations.filter(r => r.data && r.data.is_disposed === false).length;

                    console.log('Summary:', {
                        total: reservations.length,
                        disposed: disposedCount,
                        undisposed: undisposedCount,
                        rooms: rooms.length,
                        roomDetails: roomDetails.length
                    });
                },
                showData: () => console.log({ reservations, roomDetails, rooms }),
                rerender: () => renderTimeline()
            };
        });
    </script>
</body>

</html>