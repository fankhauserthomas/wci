<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Unified - Single Canvas Rendering</title>
    <style>
        :root {
            /* Unified modal color system (keine visuellen √Ñnderungen, nur zentralisierte Variablen) */
            --modal-overlay-bg: rgba(0, 0, 0, 0.7);
            --modal-bg: #2c2c2c;
            --modal-border: #555;
            --modal-header-color: #f5f5f5;
            --modal-body-color: #cccccc;
            --modal-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            --modal-input-bg: #1a1a1a;
            --modal-input-border: #555;
            --modal-input-color: #f5f5f5;
            --modal-input-focus: #007bff;
            --modal-textarea-focus-shadow: rgba(255, 215, 0, 0.25);
            --modal-btn-cancel-bg: #555;
            --modal-btn-cancel-bg-hover: #666;
            --modal-btn-danger-bg: #dc3545;
            --modal-btn-danger-bg-hover: #c82333;
            --modal-btn-primary-bg: #007bff;
            --modal-btn-primary-bg-hover: #0056b3;
            --modal-btn-secondary-bg: #6c757d;
            --modal-btn-secondary-bg-hover: #5a6268;
            --modal-checkbox-accent: #007bff;
            --dataset-section-bg: #2a2a2a;
            --dataset-section-border: #444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2c2c2c;
            padding: 0;
        }

        .main-areas-container {
            background: #2c2c2c;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .timeline-unified-container {
            position: relative !important;
        }

        .scroll-horizontal::-webkit-scrollbar,
        .scroll-vertical::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .scroll-horizontal::-webkit-scrollbar-track,
        .scroll-vertical::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .scroll-horizontal::-webkit-scrollbar-thumb,
        .scroll-vertical::-webkit-scrollbar-thumb {
            background: #555555;
            border-radius: 6px;
        }

        .scroll-horizontal::-webkit-scrollbar-thumb:hover,
        .scroll-vertical::-webkit-scrollbar-thumb:hover {
            background: #777777;
        }

        .performance-info {
            display: none;
            /* Performance-Info ausgeblendet */
        }

        .radial-menu {
            position: absolute;
            /* width and height set dynamically by JavaScript */
            pointer-events: none;
            z-index: 9999;
            display: none;
            /* Start slightly rotated so the show animation rotates +360¬∞ to final +90¬∞ */
            transform: rotate(-270deg) scale(0.05);
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                opacity 0.5s ease-out;
        }

        .radial-menu.active {
            display: block;
            /* Final resting orientation rotated +90¬∞ clockwise */
            transform: rotate(90deg) scale(1);
            opacity: 1;
        }

        .radial-menu.hiding {
            /* Continue the rotation direction when hiding */
            transform: rotate(450deg) scale(0.05);
            opacity: 0;
        }

        .radial-menu svg {
            /* width and height set dynamically by JavaScript */
            filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.35));
        }

        .radial-menu path.segment {
            cursor: pointer;
            pointer-events: auto;
            stroke: rgba(0, 0, 0, 0.25);
            stroke-width: 1;
        }

        .radial-menu path.segment:hover {
            filter: brightness(1.2);
        }

        .radial-menu text {
            fill: #f5f5f5;
            font-size: 11px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            pointer-events: none;
        }

        .radial-menu .center-button {
            cursor: pointer;
            pointer-events: auto;
        }

        /* Modal Dialog Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay-bg);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-dialog {
            background: var(--modal-bg);
            border: 1px solid var(--modal-border);
            border-radius: 8px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--modal-shadow);
            animation: modalSlideIn 0.2s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            color: var(--modal-header-color);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
        }

        .modal-header .icon {
            margin-right: 8px;
            font-size: 20px;
        }

        .modal-body {
            color: var(--modal-body-color);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .modal-button-cancel {
            background: var(--modal-btn-cancel-bg);
            color: var(--modal-header-color);
        }

        .modal-button-cancel:hover {
            background: var(--modal-btn-cancel-bg-hover);
        }

        .modal-button-danger {
            background: var(--modal-btn-danger-bg);
            color: white;
        }

        .modal-button-danger:hover {
            background: var(--modal-btn-danger-bg-hover);
        }

        .modal-button-primary {
            background: var(--modal-btn-primary-bg);
            color: white;
        }

        .modal-button-primary:hover {
            background: var(--modal-btn-primary-bg-hover);
        }

        /* Input Modal Styles */
        .modal-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--modal-input-border);
            border-radius: 4px;
            background: var(--modal-input-bg);
            color: var(--modal-input-color);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--modal-input-focus);
        }

        .modal-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--modal-input-border);
            border-radius: 4px;
            background: var(--modal-input-bg);
            color: var(--modal-input-color);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 16px;
        }

        .modal-textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 0 2px var(--modal-textarea-focus-shadow);
        }

        .modal-textarea::placeholder {
            color: #888;
        }

        .modal-button-secondary {
            background: var(--modal-btn-secondary-bg);
            color: white;
            border: none;
        }

        .modal-button-secondary:hover {
            background: var(--modal-btn-secondary-bg-hover);
        }

        .modal-checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            color: #cccccc;
        }

        .modal-checkbox {
            width: 16px;
            height: 16px;
            accent-color: var(--modal-checkbox-accent);
        }

        .modal-checkbox-label {
            font-size: 14px;
            cursor: pointer;
        }

        /* Dataset Modal Styles */
        .dataset-section {
            margin-bottom: 24px;
            border: 1px solid var(--dataset-section-border);
            border-radius: 6px;
            padding: 16px;
            background: var(--dataset-section-bg);
        }

        .dataset-section-title {
            color: #f5f5f5;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dataset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .dataset-field {
            display: flex;
            flex-direction: column;
        }

        .dataset-field label {
            color: #cccccc;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .dataset-field input,
        .dataset-field textarea {
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #1a1a1a;
            color: #f5f5f5;
            font-size: 14px;
        }

        .dataset-field input:focus,
        .dataset-field textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .dataset-field input:read-only {
            background: #333;
            color: #aaa;
            cursor: not-allowed;
        }

        /* Debug Console Styles */
        .debug-console {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 400px;
            height: 300px;
            background: #1a1a1a;
            border: 1px solid #555;
            border-bottom: none;
            border-right: none;
            box-shadow: -4px -4px 12px rgba(0, 0, 0, 0.3);
            z-index: 9998;
            display: none;
            flex-direction: column;
        }

        .debug-console.active {
            display: flex;
        }

        .debug-console-header {
            background: #333;
            color: #f5f5f5;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #555;
        }

        .debug-console-controls {
            display: flex;
            gap: 8px;
        }

        .debug-console-btn {
            background: #555;
            color: #f5f5f5;
            border: none;
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 2px;
            cursor: pointer;
        }

        .debug-console-btn:hover {
            background: #666;
        }

        .debug-console-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.3;
        }

        .debug-log-entry {
            margin-bottom: 4px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .debug-log-timestamp {
            color: #888;
        }

        .debug-log-level-info {
            color: #5bc0de;
        }

        .debug-log-level-warn {
            color: #f0ad4e;
        }

        .debug-log-level-error {
            color: #d9534f;
        }

        .debug-log-level-success {
            color: #5cb85c;
        }

        /* Debug Toggle Button */
        .debug-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #333;
            color: #f5f5f5;
            border: 1px solid #555;
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 9999;
            font-family: 'Courier New', monospace;
        }

        .debug-toggle:hover {
            background: #444;
        }
    </style>
</head>

<body>
    <div class="main-areas-container"></div>
    <div id="timeline-radial-menu" class="radial-menu"></div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-dialog">
            <div class="modal-header">
                <span class="icon">‚ö†Ô∏è</span>
                <span id="modal-title">Best√§tigung erforderlich</span>
            </div>
            <div class="modal-body">
                <p id="modal-message">Sind Sie sicher, dass Sie diese Aktion ausf√ºhren m√∂chten?</p>
            </div>
            <div class="modal-actions">
                <button id="modal-cancel" class="modal-button modal-button-cancel">Abbrechen</button>
                <button id="modal-confirm" class="modal-button modal-button-danger">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Designation Edit Modal -->
    <div id="designation-modal" class="modal-overlay">
        <div class="modal-dialog">
            <div class="modal-header">
                <span class="icon">‚úèÔ∏è</span>
                <span>Bezeichnung bearbeiten</span>
            </div>
            <div class="modal-body">
                <label for="designation-input"
                    style="color: #cccccc; font-size: 14px; display: block; margin-bottom: 8px;">
                    Neue Bezeichnung:
                </label>
                <input type="text" id="designation-input" class="modal-input" placeholder="Bezeichnung eingeben...">

                <div id="designation-multiple-options" class="modal-checkbox-group" style="display: none;">
                    <input type="checkbox" id="designation-update-all" class="modal-checkbox">
                    <label for="designation-update-all" class="modal-checkbox-label">
                        Alle Zimmer-Zuweisungen dieser Reservierung aktualisieren
                    </label>
                </div>
            </div>
            <div class="modal-actions">
                <button id="designation-cancel" class="modal-button modal-button-cancel">Abbrechen</button>
                <button id="designation-save" class="modal-button modal-button-primary">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Notes Edit Modal -->
    <div id="notes-modal" class="modal-overlay">
        <div class="modal-dialog">
            <div class="modal-header">
                <span>Notiz</span>
            </div>
            <div class="modal-body">
                <label for="notes-textarea"
                    style="color: #cccccc; font-size: 14px; display: block; margin-bottom: 8px;">
                    Notiz-Text:
                </label>
                <textarea id="notes-textarea" class="modal-textarea" placeholder="Ihre Notiz hier eingeben..."
                    rows="4"></textarea>

                <div class="modal-char-counter"
                    style="text-align: right; color: #999; font-size: 11px; margin-top: -8px; margin-bottom: 8px;">
                    <span id="notes-char-count">0</span> Zeichen
                </div>
            </div>
            <div class="modal-actions">
                <button id="notes-cancel" class="modal-button modal-button-cancel">Abbrechen</button>
                <button id="notes-clear" class="modal-button modal-button-secondary"
                    style="display: none;">L√∂schen</button>
                <button id="notes-save" class="modal-button modal-button-primary">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Dataset Edit Modal -->
    <div id="dataset-modal" class="modal-overlay">
        <div class="modal-dialog" style="max-width: 900px; width: 95vw;">
            <div class="modal-header">
                <span class="icon">üìã</span>
                <span>AV-Res Stammdaten bearbeiten</span>
                <div id="dataset-av-indicator"
                    style="display: none; margin-left: auto; background: #27ae60; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                    AV-Reservierung (av_id: <span id="dataset-av-id-display"></span>)
                </div>
            </div>
            <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">

                <!-- Grunddaten -->
                <div class="dataset-section">
                    <h3 class="dataset-section-title">üìã Grunddaten</h3>
                    <div class="dataset-grid">
                        <div class="dataset-field">
                            <label for="dataset-av-id">AV-ID:</label>
                            <input type="text" id="dataset-av-id" class="modal-input" readonly>
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-storno">Storno:</label>
                            <select id="dataset-storno" class="modal-input">
                                <option value="0">Aktiv</option>
                                <option value="1">Storniert</option>
                            </select>
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-hund">Hund:</label>
                            <select id="dataset-hund" class="modal-input">
                                <option value="0">Nein</option>
                                <option value="1">Ja</option>
                            </select>
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-arr">Arrangement:</label>
                            <select id="dataset-arr" class="modal-input">
                                <option value="">Kein Arrangement</option>
                                <!-- Wird dynamisch bef√ºllt -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Aufenthaltsdaten -->
                <div class="dataset-section">
                    <h3 class="dataset-section-title">üè® Aufenthaltsdaten</h3>
                    <div class="dataset-grid">
                        <div class="dataset-field">
                            <label for="dataset-anreise">Anreise:</label>
                            <input type="date" id="dataset-anreise" class="modal-input">
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-abreise">Abreise:</label>
                            <input type="date" id="dataset-abreise" class="modal-input">
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-lager">Lager:</label>
                            <input type="number" id="dataset-lager" class="modal-input" min="0">
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-betten">Betten:</label>
                            <input type="number" id="dataset-betten" class="modal-input" min="0">
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-dz">Doppelzimmer:</label>
                            <input type="number" id="dataset-dz" class="modal-input" min="0">
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-sonder">Sonderw√ºnsche:</label>
                            <input type="number" id="dataset-sonder" class="modal-input" min="0">
                        </div>
                    </div>
                </div>

                <!-- G√§steinformationen -->
                <div class="dataset-section">
                    <h3 class="dataset-section-title">üë§ G√§steinformationen</h3>
                    <div class="dataset-grid">
                        <div class="dataset-field">
                            <label for="dataset-vorname">Vorname:</label>
                            <input type="text" id="dataset-vorname" class="modal-input">
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-nachname">Nachname:</label>
                            <input type="text" id="dataset-nachname" class="modal-input">
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-email">E-Mail:</label>
                            <input type="email" id="dataset-email" class="modal-input">
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-handy">Handy:</label>
                            <input type="tel" id="dataset-handy" class="modal-input">
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-email-date">Email-Datum:</label>
                            <input type="text" id="dataset-email-date" class="modal-input" placeholder="dd.mm.yyyy">
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-origin">Herkunft:</label>
                            <select id="dataset-origin" class="modal-input">
                                <option value="">Keine Herkunft</option>
                                <!-- Wird dynamisch bef√ºllt -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Zusatzinformationen -->
                <div class="dataset-section">
                    <h3 class="dataset-section-title">‚ÑπÔ∏è Zusatzinformationen</h3>
                    <div class="dataset-grid">
                        <div class="dataset-field">
                            <label for="dataset-gruppe">Gruppenname:</label>
                            <input type="text" id="dataset-gruppe" class="modal-input">
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-bem">Bemerkungen (allgemein):</label>
                            <textarea id="dataset-bem" class="modal-input" rows="3"></textarea>
                        </div>
                        <div class="dataset-field">
                            <label for="dataset-bem-av">Bemerkungen (AV):</label>
                            <textarea id="dataset-bem-av" class="modal-input" rows="3"></textarea>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-actions">
                <button id="dataset-cancel" class="modal-button modal-button-cancel">Abbrechen</button>
                <button id="dataset-save" class="modal-button modal-button-primary">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Debug Console -->
    <div id="debug-console" class="debug-console">
        <div class="debug-console-header">
            <span>üêõ Debug Console</span>
            <div class="debug-console-controls">
                <button id="debug-clear" class="debug-console-btn">Clear</button>
                <button id="debug-export" class="debug-console-btn">Export</button>
                <button id="debug-close" class="debug-console-btn">‚úï</button>
            </div>
        </div>
        <div id="debug-console-content" class="debug-console-content">
            <!-- Debug logs will appear here -->
        </div>
    </div>

    <!-- Debug Toggle Button -->
    <button id="debug-toggle" class="debug-toggle">Debug Console</button>

    <!-- Scripts -->
    <script src="timeline-unified.js"></script>
    <script>
        if (typeof TimelineUnifiedRenderer === 'undefined') {
            console.error('FEHLER: TimelineUnifiedRenderer wurde nicht geladen!');
        }

        // ===== GLOBAL VARIABLES =====
        let timelineRenderer = null; // Timeline-Renderer-Instanz
        window.arrangementsCatalog = [];
        window.histogramSource = [];

        // ===== FUNCTION DEFINITIONS (moved to top for onclick availability) =====

        // Modal Confirmation Function
        function showConfirmationModal(title, message, confirmText = 'Best√§tigen', cancelText = 'Abbrechen') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmation-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const modalCancel = document.getElementById('modal-cancel');
                const modalConfirm = document.getElementById('modal-confirm');

                // Set content
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalCancel.textContent = cancelText;
                modalConfirm.textContent = confirmText;

                // Show modal
                modal.classList.add('active');

                // Handle button clicks
                const onCancel = () => {
                    modal.classList.remove('active');
                    resolve(false);
                    cleanup();
                };

                const onConfirm = () => {
                    modal.classList.remove('active');
                    resolve(true);
                    cleanup();
                };

                const cleanup = () => {
                    modalCancel.removeEventListener('click', onCancel);
                    modalConfirm.removeEventListener('click', onConfirm);
                    modal.removeEventListener('click', onOverlayClick);
                };

                const onOverlayClick = (e) => {
                    if (e.target === modal) {
                        onCancel();
                    }
                };

                modalCancel.addEventListener('click', onCancel);
                modalConfirm.addEventListener('click', onConfirm);
                modal.addEventListener('click', onOverlayClick);
            });
        }

        // Designation Edit Modal Function
        function showDesignationModal(currentDesignation, hasMultipleDetails = false) {
            return new Promise((resolve) => {
                const modal = document.getElementById('designation-modal');
                const designationInput = document.getElementById('designation-input');
                const designationCancel = document.getElementById('designation-cancel');
                const designationSave = document.getElementById('designation-save');
                const multipleOptions = document.getElementById('designation-multiple-options');
                const updateAllCheckbox = document.getElementById('designation-update-all');

                // Set current designation
                designationInput.value = currentDesignation || '';

                // Show/hide multiple options based on whether there are multiple details
                if (hasMultipleDetails) {
                    multipleOptions.style.display = 'flex';
                    updateAllCheckbox.checked = false; // Default: nur der betreffende Balken
                } else {
                    multipleOptions.style.display = 'none';
                }

                // Show modal
                modal.classList.add('active');
                designationInput.focus();
                designationInput.select();

                // Handle button clicks
                const onCancel = () => {
                    modal.classList.remove('active');
                    resolve(null);
                    cleanup();
                };

                const onSave = () => {
                    const newDesignation = designationInput.value.trim();
                    const updateAll = hasMultipleDetails ? updateAllCheckbox.checked : false;

                    modal.classList.remove('active');
                    resolve({
                        designation: newDesignation,
                        updateAll: updateAll
                    });
                    cleanup();
                };

                const onKeyPress = (e) => {
                    if (e.key === 'Enter') {
                        onSave();
                    } else if (e.key === 'Escape') {
                        onCancel();
                    }
                };

                const cleanup = () => {
                    designationCancel.removeEventListener('click', onCancel);
                    designationSave.removeEventListener('click', onSave);
                    designationInput.removeEventListener('keydown', onKeyPress);
                    modal.removeEventListener('click', onOverlayClick);
                };

                const onOverlayClick = (e) => {
                    if (e.target === modal) {
                        onCancel();
                    }
                };

                designationCancel.addEventListener('click', onCancel);
                designationSave.addEventListener('click', onSave);
                designationInput.addEventListener('keydown', onKeyPress);
                modal.addEventListener('click', onOverlayClick);
            });
        }

        // Notes Edit Modal Function
        function showNotesModal(currentNote = '') {
            return new Promise((resolve) => {
                const modal = document.getElementById('notes-modal');
                const notesTextarea = document.getElementById('notes-textarea');
                const notesCancel = document.getElementById('notes-cancel');
                const notesClear = document.getElementById('notes-clear');
                const notesSave = document.getElementById('notes-save');
                const charCount = document.getElementById('notes-char-count');

                // Update character counter
                const updateCharCount = () => {
                    charCount.textContent = notesTextarea.value.length;
                };

                // Set current value
                notesTextarea.value = currentNote;
                updateCharCount();

                // Show/hide clear button based on current note
                if (currentNote && currentNote.trim() !== '') {
                    notesClear.style.display = 'inline-block';
                } else {
                    notesClear.style.display = 'none';
                }

                // Show modal
                modal.classList.add('active');
                notesTextarea.focus();
                notesTextarea.select();

                // Event handlers
                const onCancel = () => {
                    cleanup();
                    modal.classList.remove('active');
                    resolve(null);
                };

                const onSave = () => {
                    const newNote = notesTextarea.value.trim();
                    cleanup();
                    modal.classList.remove('active');
                    resolve(newNote);
                };

                const onClear = () => {
                    cleanup();
                    modal.classList.remove('active');
                    resolve(''); // Empty string to clear the note
                };

                const onKeyPress = (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        onSave();
                    } else if (e.key === 'Escape') {
                        onCancel();
                    }
                };

                const cleanup = () => {
                    notesCancel.removeEventListener('click', onCancel);
                    notesClear.removeEventListener('click', onClear);
                    notesSave.removeEventListener('click', onSave);
                    notesTextarea.removeEventListener('keydown', onKeyPress);
                    notesTextarea.removeEventListener('input', updateCharCount);
                    modal.removeEventListener('click', onOverlayClick);
                };

                const onOverlayClick = (e) => {
                    if (e.target === modal) {
                        onCancel();
                    }
                };

                notesCancel.addEventListener('click', onCancel);
                notesClear.addEventListener('click', onClear);
                notesSave.addEventListener('click', onSave);
                notesTextarea.addEventListener('keydown', onKeyPress);
                notesTextarea.addEventListener('input', updateCharCount);
                modal.addEventListener('click', onOverlayClick);
            });
        }

        // Dataset Modal Function
        function showDatasetModal(detail) {
            return new Promise(async (resolve) => {
                const modal = document.getElementById('dataset-modal');
                const cancelBtn = document.getElementById('dataset-cancel');
                const saveBtn = document.getElementById('dataset-save');
                const avIndicator = document.getElementById('dataset-av-indicator');
                const avIdDisplay = document.getElementById('dataset-av-id-display');

                // Extract AV_Res data - diese Daten m√ºssen von der API kommen
                const avResId = detail.data?.res_id || detail.res_id || detail.resid;

                if (!avResId) {
                    alert('Fehler: Keine AV-Res ID gefunden');
                    resolve(null);
                    return;
                }

                try {
                    // Lade AV_Res Daten von der API
                    const response = await fetch(`getAVReservationData.php?av_res_id=${avResId}`);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('Non-JSON response:', text);
                        throw new Error('Server returned non-JSON response: ' + text.substring(0, 100));
                    }

                    const avResData = await response.json();

                    if (!avResData.success) {
                        throw new Error(avResData.message || 'Fehler beim Laden der AV-Res Daten');
                    }

                    const data = avResData.data;
                    const isAVReservation = (data.av_id || 0) > 0;

                    // Zeige AV-Indikator
                    if (isAVReservation) {
                        avIndicator.style.display = 'block';
                        avIdDisplay.textContent = data.av_id;
                    } else {
                        avIndicator.style.display = 'none';
                    }

                    // Populate Grunddaten
                    document.getElementById('dataset-av-id').value = data.av_id || '';
                    document.getElementById('dataset-storno').value = data.storno || 0;
                    document.getElementById('dataset-hund').value = data.hund || 0;

                    // Populate Aufenthaltsdaten
                    document.getElementById('dataset-anreise').value = formatDateForInput(data.anreise);
                    document.getElementById('dataset-abreise').value = formatDateForInput(data.abreise);
                    document.getElementById('dataset-lager').value = data.lager || 0;
                    document.getElementById('dataset-betten').value = data.betten || 0;
                    document.getElementById('dataset-dz').value = data.dz || 0;
                    document.getElementById('dataset-sonder').value = data.sonder || 0;

                    // Populate G√§steinformationen
                    document.getElementById('dataset-vorname').value = data.vorname || '';
                    document.getElementById('dataset-nachname').value = data.nachname || '';
                    document.getElementById('dataset-email').value = data.email || '';
                    document.getElementById('dataset-handy').value = data.handy || '';
                    document.getElementById('dataset-email-date').value = formatEmailDateForInput(data.email_date);

                    // Populate Zusatzinformationen
                    document.getElementById('dataset-gruppe').value = data.gruppe || '';
                    document.getElementById('dataset-bem').value = data.bem || '';
                    document.getElementById('dataset-bem-av').value = data.bem_av || '';

                    // Lade Dropdown-Daten und setze Werte
                    await loadArrangementDropdown(data.arr);
                    await loadOriginDropdown(data.origin);

                    // Setze Editierbarkeit basierend auf AV-Status
                    setFieldsEditability(isAVReservation);

                    // Helper-Funktionen
                    function formatDateForInput(dateStr) {
                        if (!dateStr) return '';
                        const date = new Date(dateStr);
                        return date.toISOString().split('T')[0];
                    }

                    function formatDateTimeForInput(dateStr) {
                        if (!dateStr) return '';
                        const date = new Date(dateStr);
                        return date.toISOString().slice(0, 16); // YYYY-MM-DDTHH:mm
                    }

                    function formatEmailDateForInput(dateStr) {
                        if (!dateStr) return '';
                        const date = new Date(dateStr);
                        const day = String(date.getDate()).padStart(2, '0');
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const year = date.getFullYear();
                        return `${day}.${month}.${year}`;
                    }

                    function setFieldsEditability(isAV) {
                        const avProtectedFields = [
                            'dataset-anreise', 'dataset-abreise', 'dataset-lager', 'dataset-betten',
                            'dataset-dz', 'dataset-sonder', 'dataset-gruppe', 'dataset-bem-av',
                            'dataset-vorname', 'dataset-nachname', 'dataset-handy', 'dataset-email',
                            'dataset-storno'
                        ];

                        avProtectedFields.forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            if (isAV) {
                                field.style.background = '#2a4a2a';
                                field.style.borderColor = '#27ae60';
                                field.title = 'Gesichert - √Ñnderungen werden in AV √ºbernommen';
                            } else {
                                field.style.background = '#1a1a1a';
                                field.style.borderColor = '#555';
                                field.title = '';
                            }
                        });

                        // Immer editierbare Felder
                        const alwaysEditableFields = [
                            'dataset-bem', 'dataset-arr', 'dataset-hund', 'dataset-origin'
                        ];

                        alwaysEditableFields.forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            field.style.background = '#1a1a1a';
                            field.style.borderColor = '#007bff';
                            field.title = 'Immer editierbar';
                        });
                    }

                    async function loadArrangementDropdown(selectedValue) {
                        try {
                            const response = await fetch('getArrangements.php');
                            const arrangements = await response.json();
                            const select = document.getElementById('dataset-arr');

                            select.innerHTML = '<option value="">Kein Arrangement</option>';

                            if (arrangements.success && arrangements.data) {
                                arrangements.data.forEach(arr => {
                                    const option = document.createElement('option');
                                    option.value = arr.ID;
                                    option.textContent = arr.kbez;
                                    if (arr.ID == selectedValue) option.selected = true;
                                    select.appendChild(option);
                                });
                            }
                        } catch (error) {
                            console.error('Fehler beim Laden der Arrangements:', error);
                        }
                    }

                    async function loadCountryDropdown(selectedValue) {
                        try {
                            const response = await fetch('getCountries.php');
                            const countries = await response.json();
                            const select = document.getElementById('dataset-country');

                            select.innerHTML = '<option value="">Kein Land</option>';

                            if (countries.success && countries.data) {
                                countries.data.forEach(country => {
                                    const option = document.createElement('option');
                                    option.value = country.id;
                                    option.textContent = country.country;
                                    if (country.id == selectedValue) option.selected = true;
                                    select.appendChild(option);
                                });
                            }
                        } catch (error) {
                            console.error('Fehler beim Laden der L√§nder:', error);
                        }
                    }

                    async function loadOriginDropdown(selectedValue) {
                        try {
                            const response = await fetch('getOrigins.php');
                            const origins = await response.json();
                            const select = document.getElementById('dataset-origin');

                            select.innerHTML = '<option value="">Keine Herkunft</option>';

                            if (origins.success && origins.data) {
                                // Sortiere nach sort-Feld
                                origins.data.sort((a, b) => (a.sort || 0) - (b.sort || 0));

                                origins.data.forEach(origin => {
                                    const option = document.createElement('option');
                                    option.value = origin.ID;
                                    option.textContent = origin.country;
                                    if (origin.ID == selectedValue) option.selected = true;
                                    select.appendChild(option);
                                });
                            }
                        } catch (error) {
                            console.error('Fehler beim Laden der Herk√ºnfte:', error);
                        }
                    }

                    // Show modal
                    modal.classList.add('active');

                    // Event handlers
                    const onCancel = () => {
                        cleanup();
                        modal.classList.remove('active');
                        resolve(null);
                    };

                    const onSave = () => {
                        // Sammle alle Formulardaten
                        const formData = {
                            av_res_id: avResId,
                            av_id: data.av_id,
                            isAVReservation: isAVReservation,

                            // Original-Daten f√ºr Vergleich
                            originalData: data,

                            // Grunddaten
                            storno: parseInt(document.getElementById('dataset-storno').value) || 0,
                            hund: parseInt(document.getElementById('dataset-hund').value) || 0,
                            arr: parseInt(document.getElementById('dataset-arr').value) || null,

                            // Aufenthaltsdaten
                            anreise: document.getElementById('dataset-anreise').value,
                            abreise: document.getElementById('dataset-abreise').value,
                            lager: parseInt(document.getElementById('dataset-lager').value) || 0,
                            betten: parseInt(document.getElementById('dataset-betten').value) || 0,
                            dz: parseInt(document.getElementById('dataset-dz').value) || 0,
                            sonder: parseInt(document.getElementById('dataset-sonder').value) || 0,

                            // G√§steinformationen
                            vorname: document.getElementById('dataset-vorname').value.trim(),
                            nachname: document.getElementById('dataset-nachname').value.trim(),
                            email: document.getElementById('dataset-email').value.trim(),
                            handy: document.getElementById('dataset-handy').value.trim(),
                            origin: parseInt(document.getElementById('dataset-origin').value) || null,

                            // Zusatzinformationen
                            gruppe: document.getElementById('dataset-gruppe').value.trim(),
                            bem: document.getElementById('dataset-bem').value.trim(),
                            bem_av: document.getElementById('dataset-bem-av').value.trim()
                        };

                        cleanup();
                        modal.classList.remove('active');
                        resolve(formData);
                    };

                    const onKeyPress = (e) => {
                        if (e.key === 'Escape') {
                            onCancel();
                        }
                    };

                    const cleanup = () => {
                        cancelBtn.removeEventListener('click', onCancel);
                        saveBtn.removeEventListener('click', onSave);
                        document.removeEventListener('keydown', onKeyPress);
                    };

                    cancelBtn.addEventListener('click', onCancel);
                    saveBtn.addEventListener('click', onSave);
                    document.addEventListener('keydown', onKeyPress);

                } catch (error) {
                    console.error('Fehler beim Laden der AV-Res Daten:', error);

                    // Fallback: Verwende Dummy-Daten f√ºr Demo
                    console.warn('Using fallback dummy data for AV_Res');
                    const avResData = {
                        success: true,
                        data: {
                            av_id: 0,
                            anreise: detail.start || '2025-09-20',
                            abreise: detail.end || '2025-09-22',
                            lager: 1,
                            betten: 2,
                            dz: 0,
                            sonder: 0,
                            vorname: 'Demo',
                            nachname: 'Gast',
                            email: 'demo@example.com',
                            handy: '+43 123 456789',
                            email_date: null,
                            gruppe: 'Test Gruppe',
                            bem: 'Testbemerkung',
                            bem_av: '',
                            storno: 0,
                            arr: null,
                            country_id: null,
                            origin: null,
                            hund: detail.data?.hund || 0
                        }
                    };

                    // Continue with fallback data
                    const data = avResData.data;
                    const isAVReservation = (data.av_id || 0) > 0;

                    // Helper-Funktionen definieren BEVOR sie verwendet werden
                    function formatDateForInput(dateStr) {
                        if (!dateStr) return '';
                        const date = new Date(dateStr);
                        return date.toISOString().split('T')[0];
                    }

                    function formatDateTimeForInput(dateStr) {
                        if (!dateStr) return '';
                        const date = new Date(dateStr);
                        return date.toISOString().slice(0, 16); // YYYY-MM-DDTHH:mm
                    }

                    function setFieldsEditability(isAV) {
                        const avProtectedFields = [
                            'dataset-anreise', 'dataset-abreise', 'dataset-lager', 'dataset-betten',
                            'dataset-dz', 'dataset-sonder', 'dataset-gruppe', 'dataset-bem-av',
                            'dataset-vorname', 'dataset-nachname', 'dataset-handy', 'dataset-email',
                            'dataset-storno'
                        ];

                        avProtectedFields.forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            if (isAV) {
                                field.style.background = '#2a4a2a';
                                field.style.borderColor = '#27ae60';
                                field.title = 'Gesichert - √Ñnderungen werden in AV √ºbernommen';
                            } else {
                                field.style.background = '#1a1a1a';
                                field.style.borderColor = '#555';
                                field.title = '';
                            }
                        });

                        // Immer editierbare Felder
                        const alwaysEditableFields = [
                            'dataset-bem', 'dataset-arr', 'dataset-hund', 'dataset-origin'
                        ];

                        alwaysEditableFields.forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            field.style.background = '#1a1a1a';
                            field.style.borderColor = '#007bff';
                            field.title = 'Immer editierbar';
                        });
                    }

                    async function loadArrangementDropdown(selectedValue) {
                        try {
                            const select = document.getElementById('dataset-arr');
                            select.innerHTML = '<option value="">Kein Arrangement</option>';
                            // Fallback: Nur Dummy-Optionen
                            const dummyArrangements = [
                                { ID: 1, kbez: 'Standard' },
                                { ID: 2, kbez: 'Halbpension' },
                                { ID: 3, kbez: 'Vollpension' }
                            ];
                            dummyArrangements.forEach(arr => {
                                const option = document.createElement('option');
                                option.value = arr.ID;
                                option.textContent = arr.kbez;
                                if (arr.ID == selectedValue) option.selected = true;
                                select.appendChild(option);
                            });
                        } catch (error) {
                            console.error('Fehler beim Laden der Arrangements:', error);
                        }
                    }

                    async function loadCountryDropdown(selectedValue) {
                        try {
                            const select = document.getElementById('dataset-country');
                            select.innerHTML = '<option value="">Kein Land</option>';
                            // Fallback: Nur Dummy-Optionen
                            const dummyCountries = [
                                { id: 1, country: 'Deutschland' },
                                { id: 2, country: '√ñsterreich' },
                                { id: 3, country: 'Schweiz' }
                            ];
                            dummyCountries.forEach(country => {
                                const option = document.createElement('option');
                                option.value = country.id;
                                option.textContent = country.country;
                                if (country.id == selectedValue) option.selected = true;
                                select.appendChild(option);
                            });
                        } catch (error) {
                            console.error('Fehler beim Laden der L√§nder:', error);
                        }
                    }

                    async function loadOriginDropdown(selectedValue) {
                        try {
                            const select = document.getElementById('dataset-origin');
                            select.innerHTML = '<option value="">Keine Herkunft</option>';
                            // Fallback: Nur Dummy-Optionen
                            const dummyOrigins = [
                                { ID: 1, country: 'Online' },
                                { ID: 2, country: 'Telefon' },
                                { ID: 3, country: 'Email' }
                            ];
                            dummyOrigins.forEach(origin => {
                                const option = document.createElement('option');
                                option.value = origin.ID;
                                option.textContent = origin.country;
                                if (origin.ID == selectedValue) option.selected = true;
                                select.appendChild(option);
                            });
                        } catch (error) {
                            console.error('Fehler beim Laden der Herk√ºnfte:', error);
                        }
                    }

                    // Zeige AV-Indikator
                    if (isAVReservation) {
                        avIndicator.style.display = 'block';
                        avIdDisplay.textContent = data.av_id;
                    } else {
                        avIndicator.style.display = 'none';
                    }

                    // Populate Grunddaten
                    document.getElementById('dataset-av-id').value = data.av_id || '';
                    document.getElementById('dataset-storno').value = data.storno || 0;
                    document.getElementById('dataset-hund').value = data.hund || 0;

                    // Populate Aufenthaltsdaten
                    document.getElementById('dataset-anreise').value = formatDateForInput(data.anreise);
                    document.getElementById('dataset-abreise').value = formatDateForInput(data.abreise);
                    document.getElementById('dataset-lager').value = data.lager || 0;
                    document.getElementById('dataset-betten').value = data.betten || 0;
                    document.getElementById('dataset-dz').value = data.dz || 0;
                    document.getElementById('dataset-sonder').value = data.sonder || 0;

                    // Populate G√§steinformationen
                    document.getElementById('dataset-vorname').value = data.vorname || '';
                    document.getElementById('dataset-nachname').value = data.nachname || '';
                    document.getElementById('dataset-email').value = data.email || '';
                    document.getElementById('dataset-handy').value = data.handy || '';
                    document.getElementById('dataset-email-date').value = formatEmailDateForInput(data.email_date);

                    // Populate Zusatzinformationen
                    document.getElementById('dataset-gruppe').value = data.gruppe || '';
                    document.getElementById('dataset-bem').value = data.bem || '';
                    document.getElementById('dataset-bem-av').value = data.bem_av || '';

                    // Lade Dropdown-Daten und setze Werte
                    await loadArrangementDropdown(data.arr);
                    await loadOriginDropdown(data.origin);

                    // Setze Editierbarkeit basierend auf AV-Status
                    setFieldsEditability(isAVReservation);

                    // Show modal
                    modal.classList.add('active');

                    // Event handlers
                    const onCancel = () => {
                        cleanup();
                        modal.classList.remove('active');
                        resolve(null);
                    };

                    const onSave = () => {
                        // Sammle alle Formulardaten f√ºr Fallback
                        const formData = {
                            av_res_id: avResId,
                            av_id: data.av_id,
                            isAVReservation: isAVReservation,

                            // Grunddaten
                            storno: parseInt(document.getElementById('dataset-storno').value) || 0,
                            hund: parseInt(document.getElementById('dataset-hund').value) || 0,
                            arr: parseInt(document.getElementById('dataset-arr').value) || null,

                            // Aufenthaltsdaten
                            anreise: document.getElementById('dataset-anreise').value,
                            abreise: document.getElementById('dataset-abreise').value,
                            lager: parseInt(document.getElementById('dataset-lager').value) || 0,
                            betten: parseInt(document.getElementById('dataset-betten').value) || 0,
                            dz: parseInt(document.getElementById('dataset-dz').value) || 0,
                            sonder: parseInt(document.getElementById('dataset-sonder').value) || 0,

                            // G√§steinformationen
                            vorname: document.getElementById('dataset-vorname').value.trim(),
                            nachname: document.getElementById('dataset-nachname').value.trim(),
                            email: document.getElementById('dataset-email').value.trim(),
                            handy: document.getElementById('dataset-handy').value.trim(),
                            origin: parseInt(document.getElementById('dataset-origin').value) || null,

                            // Zusatzinformationen
                            gruppe: document.getElementById('dataset-gruppe').value.trim(),
                            bem: document.getElementById('dataset-bem').value.trim(),
                            bem_av: document.getElementById('dataset-bem-av').value.trim()
                        };

                        cleanup();
                        modal.classList.remove('active');
                        resolve(formData);
                    };

                    const onKeyPress = (e) => {
                        if (e.key === 'Escape') {
                            onCancel();
                        }
                    };

                    const cleanup = () => {
                        cancelBtn.removeEventListener('click', onCancel);
                        saveBtn.removeEventListener('click', onSave);
                        document.removeEventListener('keydown', onKeyPress);
                        modal.removeEventListener('click', onOverlayClick);
                    };

                    const onOverlayClick = (e) => {
                        if (e.target === modal) {
                            onCancel();
                        }
                    };

                    cancelBtn.addEventListener('click', onCancel);
                    saveBtn.addEventListener('click', onSave);
                    document.addEventListener('keydown', onKeyPress);
                    modal.addEventListener('click', onOverlayClick);
                }
            });
        }

        // Dataset command handler
        async function handleDatasetCommand(detail) {
            try {
                const result = await showDatasetModal(detail);
                if (result) {
                    // Update AV_Res data via API
                    const response = await fetch('updateReservationMasterData.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(result)
                    });

                    const updateResult = await response.json();

                    if (updateResult.success) {
                        showToast('AV-Res Daten erfolgreich aktualisiert', 'success');

                        // Aktualisiere lokale Daten wenn verf√ºgbar
                        if (detail.data) {
                            Object.assign(detail.data, result);
                        }

                        // Re-render um √Ñnderungen anzuzeigen
                        if (timelineRenderer) {
                            timelineRenderer.render();
                        }

                        // Spezielle Behandlung f√ºr Hund-√Ñnderungen
                        if (result.hund !== undefined) {
                            // Aktualisiere auch AV_ResDet.hund f√ºr visuellen Effekt
                            await updateDetailHundStatus(detail, result.hund);
                        }
                    } else {
                        throw new Error(updateResult.message || 'Unbekannter Fehler beim Speichern');
                    }
                } else {
                    console.log('Dataset modal cancelled');
                }
            } catch (error) {
                console.error('Error in handleDatasetCommand:', error);
                showToast('Fehler beim Aktualisieren der Daten: ' + error.message, 'error');
            }
        }

        // Helper function f√ºr Hund-Status Update
        async function updateDetailHundStatus(detail, hundStatus) {
            try {
                const detailUpdateData = {
                    id: detail.id,
                    hund: hundStatus ? 1 : 0
                };

                const response = await fetch('updateRoomDetailAttributes.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(detailUpdateData)
                });

                const result = await response.json();

                if (result.success) {
                    // Update local data
                    if (detail.data) {
                        detail.data.hund = hundStatus ? 1 : 0;
                    }
                    console.log('Detail hund status synchronized with AV_Res');
                } else {
                    console.warn('Failed to sync detail hund status:', result.message);
                }
            } catch (error) {
                console.error('Error syncing detail hund status:', error);
            }
        }

        // Debug Console Functions
        const DebugConsole = {
            logs: [],
            isVisible: false,

            init() {
                const toggle = document.getElementById('debug-toggle');
                const console = document.getElementById('debug-console');
                const clearBtn = document.getElementById('debug-clear');
                const exportBtn = document.getElementById('debug-export');
                const closeBtn = document.getElementById('debug-close');

                toggle.addEventListener('click', () => this.toggle());
                clearBtn.addEventListener('click', () => this.clear());
                exportBtn.addEventListener('click', () => this.export());
                closeBtn.addEventListener('click', () => this.hide());

                // Intercept console methods
                this.interceptConsole();
            },

            toggle() {
                if (this.isVisible) {
                    this.hide();
                } else {
                    this.show();
                }
            },

            show() {
                document.getElementById('debug-console').classList.add('active');
                this.isVisible = true;
                this.scrollToBottom();
            },

            hide() {
                document.getElementById('debug-console').classList.remove('active');
                this.isVisible = false;
            },

            clear() {
                this.logs = [];
                document.getElementById('debug-console-content').innerHTML = '';
            },

            export() {
                const content = this.logs.map(log =>
                    `[${log.timestamp}] ${log.level.toUpperCase()}: ${log.message}`
                ).join('\n');

                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `timeline-debug-${new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-')}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            },

            log(level, ...args) {
                const timestamp = new Date().toLocaleTimeString();
                const message = args.map(arg =>
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' ');

                const logEntry = { timestamp, level, message };
                this.logs.push(logEntry);

                // Limit logs to last 100 entries
                if (this.logs.length > 100) {
                    this.logs.shift();
                }

                this.render(logEntry);
            },

            render(logEntry) {
                const content = document.getElementById('debug-console-content');
                const entry = document.createElement('div');
                entry.className = 'debug-log-entry';

                entry.innerHTML = `<span class="debug-log-timestamp">[${logEntry.timestamp}]</span> <span class="debug-log-level-${logEntry.level}">${logEntry.level.toUpperCase()}:</span> ${logEntry.message}`;

                content.appendChild(entry);
                this.scrollToBottom();
            },

            scrollToBottom() {
                const content = document.getElementById('debug-console-content');
                content.scrollTop = content.scrollHeight;
            },

            interceptConsole() {
                const originalMethods = {
                    log: console.log,
                    info: console.info,
                    warn: console.warn,
                    error: console.error
                };

                console.log = (...args) => {
                    originalMethods.log(...args);
                    this.log('info', ...args);
                };

                console.info = (...args) => {
                    originalMethods.info(...args);
                    this.log('info', ...args);
                };

                console.warn = (...args) => {
                    originalMethods.warn(...args);
                    this.log('warn', ...args);
                };

                console.error = (...args) => {
                    originalMethods.error(...args);
                    this.log('error', ...args);
                };

                // Custom debug method
                console.debug = (...args) => {
                    originalMethods.log(...args);
                    this.log('info', ...args);
                };

                // Custom success method
                console.success = (...args) => {
                    originalMethods.log(...args);
                    this.log('success', ...args);
                };
            }
        };

        // Initialize Debug Console when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => DebugConsole.init());
        } else {
            DebugConsole.init();
        }

        // Echte Daten laden (API-Integration)
        async function loadRealData() {
            try {
                const MS_IN_DAY = 24 * 60 * 60 * 1000;
                const now = new Date();
                now.setHours(0, 0, 0, 0);

                // Datumsbereich aus Konfiguration (Cookie/LS) + Live-Overrides
                const { past: weeksPast, future: weeksFuture } = getConfiguredWeeksRange();
                const startDate = new Date(now.getTime() - (weeksPast * 7 * MS_IN_DAY));
                const endDate = new Date(now.getTime() + (weeksFuture * 7 * MS_IN_DAY));

                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];

                console.log(`Lade Zimmerplan-Daten f√ºr ${startDateStr} bis ${endDateStr}`);

                const roomsFetchPromise = fetch('getRooms.php').catch(error => error);
                const arrangementsFetchPromise = fetch('../get-arrangements.php').catch(error => error);
                const histogramFetchPromise = fetch(`getHistogramSource.php?start=${startDateStr}&end=${endDateStr}`).catch(error => error);

                const dataResponse = await fetch(`getZimmerplanData.php?start=${startDateStr}&end=${endDateStr}`);

                if (!dataResponse.ok) {
                    throw new Error(`Zimmerplan-API HTTP ${dataResponse.status}: ${dataResponse.statusText}`);
                }

                const result = await dataResponse.json();

                if (!result.success) {
                    throw new Error(result.error || 'API-Fehler');
                }

                const apiData = result.data || {};

                const roomDetailsSource = Array.isArray(apiData.room_details) ? apiData.room_details : [];
                roomDetails = roomDetailsSource
                    .filter(item => item.room_id && item.start && item.end)
                    .map(item => {
                        const detailData = item.data || {};
                        const detailId = detailData.detail_id || null;
                        const reservationId = detailData.res_id || null;
                        const roomId = item.room_id || detailData.room_id || null;
                        const caption = detailData.caption || detailData.guest_name || '';

                        return {
                            id: item.id || (detailId ? `room_detail_${detailId}` : undefined),
                            detail_id: detailId,
                            res_id: reservationId,
                            reservation_id: reservationId,
                            room_id: roomId,
                            arr_id: detailData.arr_id || item.arr_id || null,
                            av_id: detailData.av_id || item.av_id || null,
                            guest_name: detailData.guest_name || 'Unbekannt',
                            caption,
                            start: parseAPIDate(item.start),
                            end: parseAPIDate(item.end),
                            color: detailData.color || '#3498db',
                            has_dog: detailData.has_dog || false,
                            capacity: detailData.capacity || 1,
                            arrangement_label: detailData.arrangement || detailData.arrangement_kbez || '',
                            ParentID: detailData.ParentID || item.ParentID || 0,
                            note: detailData.note || '',
                            dx: detailData.dx || 0,
                            dy: detailData.dy || 0,
                            data: {
                                ...detailData,
                                detail_id: detailId,
                                res_id: reservationId,
                                room_id: roomId,
                                arr_id: detailData.arr_id || item.arr_id || null,
                                av_id: detailData.av_id || item.av_id || null,
                                caption,
                                ParentID: detailData.ParentID || item.ParentID || 0
                            }
                        };
                    });

                const timelineItems = Array.isArray(apiData.timeline_items) ? apiData.timeline_items : [];
                reservations = timelineItems
                    .filter(item => item && item.content && item.start && item.end)
                    .filter(item => !(item.data && item.data.is_disposed))
                    .map((item, index) => {
                        const itemData = item.data || {};
                        return {
                            id: item.id || index,
                            name: item.name || itemData.guest_name || item.content.replace(/<[^>]*>/g, ''),
                            nachname: item.nachname || '',
                            vorname: item.vorname || '',
                            start: parseAPIDate(item.start),
                            end: parseAPIDate(item.end),
                            capacity: item.capacity || itemData.capacity || 1,
                            arrangement_name: item.arrangement_name || item.arr_kbez || '',
                            arr_kbez: item.arr_kbez || '',
                            has_dog: item.has_dog || item.hund || itemData.has_dog || false,
                            hund: item.hund || item.has_dog || false,
                            fullData: itemData
                        };
                    });

                const roomsResponse = await roomsFetchPromise;
                let roomsResult = null;
                let roomsResponseStatus = null;

                if (roomsResponse instanceof Response) {
                    roomsResponseStatus = `HTTP ${roomsResponse.status}: ${roomsResponse.statusText}`;
                    if (roomsResponse.ok) {
                        roomsResult = await roomsResponse.json();
                    } else {
                        try {
                            roomsResult = await roomsResponse.json();
                        } catch (parseError) {
                            // Falls keine JSON-Antwort geliefert wurde, ignorieren wir den Fehler
                        }
                    }
                }

                if (roomsResult && roomsResult.success) {
                    rooms = Array.isArray(roomsResult.data) ? [...roomsResult.data] : [];
                    rooms.sort((a, b) => {
                        const sortA = a.sort !== undefined ? a.sort : a.id;
                        const sortB = b.sort !== undefined ? b.sort : b.id;
                        return sortA - sortB;
                    });
                } else {
                    let statusInfo;
                    if (roomsResponse instanceof Response && roomsResponse.ok) {
                        statusInfo = roomsResult && roomsResult.error ? roomsResult.error : 'Unbekannter Fehler';
                    } else if (roomsResponse instanceof Error) {
                        statusInfo = roomsResponse.message || 'Netzwerkfehler';
                    } else {
                        statusInfo = roomsResponseStatus || 'Unbekannter Fehler';
                    }
                    console.warn(`Zimmer konnten nicht geladen werden (${statusInfo}), verwende Fallback.`);
                    rooms = [
                        { id: 1, caption: 'Zimmer 1', capacity: 2, display_name: 'Zimmer 1 (2P)' },
                        { id: 2, caption: 'Zimmer 2', capacity: 4, display_name: 'Zimmer 2 (4P)' },
                        { id: 3, caption: 'Zimmer 3', capacity: 3, display_name: 'Zimmer 3 (3P)' }
                    ];
                }

                arrangementsCatalog = [];
                const arrangementsResponse = await arrangementsFetchPromise;
                if (arrangementsResponse instanceof Response && arrangementsResponse.ok) {
                    try {
                        const arrJson = await arrangementsResponse.json();
                        if (arrJson && typeof arrJson === 'object') {
                            arrangementsCatalog = Object.entries(arrJson).map(([id, label]) => {
                                const cleanLabel = typeof label === 'string' ? label.trim() : '';
                                const shortLabel = cleanLabel.split(/\s+/)[0] || cleanLabel || 'n/a';
                                const numericId = Number(id);
                                return {
                                    id: Number.isFinite(numericId) ? numericId : id,
                                    rawId: id,
                                    label: cleanLabel || 'n/a',
                                    shortLabel
                                };
                            });
                        }
                    } catch (arrError) {
                        console.warn('Arrangements konnten nicht geparst werden:', arrError);
                    }
                } else if (arrangementsResponse instanceof Error) {
                    console.warn('Arrangements konnten nicht geladen werden:', arrangementsResponse.message);
                }

                window.arrangementsCatalog = arrangementsCatalog;

                let histogramSource = [];
                const histogramResponse = await histogramFetchPromise;
                console.log('üîç Histogramm Response:', histogramResponse);

                if (histogramResponse instanceof Response && histogramResponse.ok) {
                    try {
                        const histogramJson = await histogramResponse.json();
                        console.log('üìä Histogramm JSON:', histogramJson);

                        if (histogramJson && histogramJson.success && histogramJson.data?.histogram) {
                            histogramSource = histogramJson.data.histogram.map(entry => ({
                                id: Number(entry.id),
                                start: entry.start,
                                end: entry.end,
                                guest_name: entry.guest_name || '',
                                capacity_details: entry.capacity_details || {}
                            }));
                            console.log(`‚úÖ ${histogramSource.length} Histogramm-Eintr√§ge verarbeitet`);
                        } else {
                            console.warn('‚ùå Histogramm JSON hat keine g√ºltige Struktur:', histogramJson);
                        }
                    } catch (histError) {
                        console.warn('‚ùå Histogrammdaten konnten nicht geparst werden:', histError);
                    }
                } else if (histogramResponse instanceof Error) {
                    console.warn('‚ùå Histogrammdaten konnten nicht geladen werden:', histogramResponse.message);
                } else {
                    console.warn('‚ùå Histogramm Response nicht OK:', histogramResponse?.status, histogramResponse?.statusText);
                }

                window.histogramSource = histogramSource;
                histogramSourceData = window.histogramSource;
                arrangementsCatalog = window.arrangementsCatalog;

                console.log(`‚úÖ Daten geladen: ${reservations.length} Reservierungen, ${roomDetails.length} Zuweisungen, ${rooms.length} Zimmer`);

                renderTimeline();

            } catch (error) {
                console.error('Fehler beim Laden der echten Daten:', error);
                // Bei Fehler: leere Timeline anzeigen
                reservations = [];
                roomDetails = [];
                rooms = [];
                arrangementsCatalog = [];
                window.arrangementsCatalog = [];
                window.histogramSource = [];
                histogramSourceData = [];
                renderTimeline();
            }
        }

        // API-Datum-Parser (kompatibel mit getZimmerplanData.php)
        function parseAPIDate(dateString) {
            if (!dateString) return new Date();

            dateString = dateString.trim();

            // ISO-Format (YYYY-MM-DD oder YYYY-MM-DD HH:MM:SS)
            if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) {
                return new Date(dateString);
            }

            // Deutsches Format (DD.MM.YYYY)
            if (/^\d{1,2}\.\d{1,2}\.\d{4}/.test(dateString)) {
                const parts = dateString.split('.');
                if (parts.length >= 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    return new Date(year, month, day, 12, 0, 0, 0);
                }
            }

            return new Date(dateString);
        }

        // Rendere Timeline (Canvas)
        function renderTimeline() {
            // Pr√ºfe ob TimelineUnifiedRenderer verf√ºgbar ist
            if (typeof TimelineUnifiedRenderer === 'undefined') {
                console.error('TimelineUnifiedRenderer ist nicht verf√ºgbar. Pr√ºfe, ob timeline-unified.js korrekt geladen wurde.');
                return;
            }

            // Pr√ºfe ob Container existiert
            const container = document.querySelector('.main-areas-container');
            if (!container) {
                console.error('Container .main-areas-container nicht gefunden');
                return;
            }

            if (timelineRenderer) {
                console.debug('Aktualisiere bestehende Timeline-Instanz.');
                timelineRenderer.setArrangementsCatalog(arrangementsCatalog);
                timelineRenderer.setHistogramSource(window.histogramSource);
                timelineRenderer.updateData(reservations, roomDetails, rooms);
            } else {
                console.debug('Erzeuge neue Timeline-Instanz.');
                timelineRenderer = new TimelineUnifiedRenderer('.main-areas-container');
                timelineRenderer.setArrangementsCatalog(arrangementsCatalog);
                timelineRenderer.setHistogramSource(window.histogramSource);
                timelineRenderer.updateData(reservations, roomDetails, rooms);
            }
        }

        // ===== INITIALIZATION AND PERFORMANCE MONITORING =====

        // Performance Monitoring deaktiviert
        /*
        let fps = 0;
        let lastFrame = performance.now();
        let frameCount = 0;

        function updatePerformanceInfo() {
            const now = performance.now();
            frameCount++;

            if (now - lastFrame >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFrame = now;

                document.getElementById('fps').textContent = fps;
                document.getElementById('reservations-count').textContent = reservations.length;
                document.getElementById('rooms-count').textContent = rooms.length;
            }

            requestAnimationFrame(updatePerformanceInfo);
        }
        updatePerformanceInfo();
        */

        // ===== VARIABLES AND INITIALIZATION =====

        // Globale Variablen f√ºr Kompatibilit√§t
        let showDisposedReservations = true;

        // Globale Hilfsfunktion: Konfiguration lesen (Cookie/localStorage) + Live-Overrides
        function getConfiguredWeeksRange() {
            // Live-Overrides bevorzugen (durch Konfig-Seite via postMessage)
            const override = (window.timelineWeeksOverride || {});
            let past = typeof override.past === 'number' ? override.past : undefined;
            let future = typeof override.future === 'number' ? override.future : undefined;

            // Aus Cookie lesen
            try {
                const cookieValue = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('timeline_config='))
                    ?.split('=')[1];
                if (cookieValue) {
                    const cfg = JSON.parse(decodeURIComponent(cookieValue));
                    if (typeof past !== 'number' && typeof cfg.weeksPast === 'number') past = cfg.weeksPast;
                    if (typeof future !== 'number' && typeof cfg.weeksFuture === 'number') future = cfg.weeksFuture;
                }
            } catch (e) {
                console.warn('Konfig aus Cookie konnte nicht gelesen werden:', e);
            }

            // Fallback: localStorage
            try {
                const ls = localStorage.getItem('timeline_config');
                if (ls) {
                    const cfg = JSON.parse(ls);
                    if (typeof past !== 'number' && typeof cfg.weeksPast === 'number') past = cfg.weeksPast;
                    if (typeof future !== 'number' && typeof cfg.weeksFuture === 'number') future = cfg.weeksFuture;
                }
            } catch (e) {
                console.warn('Konfig aus localStorage konnte nicht gelesen werden:', e);
            }

            // Defaults + Begrenzungen
            if (typeof past !== 'number' || isNaN(past)) past = 2;
            if (typeof future !== 'number' || isNaN(future)) future = 104;
            // clamp auf UI-Grenzen
            past = Math.max(0, Math.min(52, past));
            future = Math.max(4, Math.min(208, future));
            return { past, future };
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', () => {
            // Message listener f√ºr Konfigurationsupdates

            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'updateMetric') {
                    console.log('Received config update:', event.data);

                    if (event.data.metric === 'menu-size' && timelineRenderer) {
                        const menuSize = event.data.value;
                        console.log('Updating menu size to:', menuSize);

                        // Update the radial menu size
                        if (timelineRenderer.updateMenuSize) {
                            timelineRenderer.updateMenuSize(menuSize);
                        } else {
                            // Fallback: update the global constant and force re-render
                            window.TIMELINE_RADIAL_MENU_SIZE = menuSize;
                            const radialMenu = document.getElementById('timeline-radial-menu');
                            if (radialMenu) {
                                radialMenu.style.width = `${menuSize}px`;
                                radialMenu.style.height = `${menuSize}px`;
                                radialMenu.style.marginLeft = `-${menuSize / 2}px`;
                                radialMenu.style.marginTop = `-${menuSize / 2}px`;
                            }
                        }
                    } else if ((event.data.metric === 'weeks-past' || event.data.metric === 'weeks-future')) {
                        // Live-Overrides merken
                        const val = parseFloat(event.data.value);
                        window.timelineWeeksOverride = window.timelineWeeksOverride || {};
                        if (event.data.metric === 'weeks-past') window.timelineWeeksOverride.past = val;
                        if (event.data.metric === 'weeks-future') window.timelineWeeksOverride.future = val;

                        // Renderer live updaten (sichtbarer Bereich)
                        if (timelineRenderer) {
                            if (!timelineRenderer.themeConfig) {
                                timelineRenderer.themeConfig = {};
                            }
                            if (event.data.metric === 'weeks-past') {
                                timelineRenderer.themeConfig.weeksPast = val;
                            } else if (event.data.metric === 'weeks-future') {
                                timelineRenderer.themeConfig.weeksFuture = val;
                            }
                            if (typeof timelineRenderer.scheduleRender === 'function') {
                                timelineRenderer.scheduleRender('weeks_range_change');
                            }
                        }
                    }
                }
            });

            // Pr√ºfe auf Theme-Updates (wenn von Konfiguration zur√ºckgekehrt)
            window.addEventListener('focus', () => {
                if (timelineRenderer && timelineRenderer.refreshThemeConfiguration) {
                    timelineRenderer.refreshThemeConfiguration();
                }
            });

            // Hinweis: Kein Abfangen von F5/Ctrl+R mehr ‚Äì Browser-Reload bleibt Standardverhalten

            // Automatisch echte Daten laden beim Seitenaufruf
            setTimeout(() => {
                console.debug('Automatischer Datenabruf nach Seitenstart.');
                console.debug('TimelineUnifiedRenderer verf√ºgbar:', typeof TimelineUnifiedRenderer);

                // Versuche echte Daten zu laden
                loadRealData().catch(error => {
                    console.error('Auto-load failed:', error);
                });
            }, 100); // 100ms Verz√∂gerung
        });
    </script>
</body>

</html>