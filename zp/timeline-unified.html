<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Unified - Single Canvas Rendering</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2c2c2c;
            padding: 0;
        }

        .main-areas-container {
            background: #2c2c2c;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .timeline-unified-container {
            position: relative !important;
        }

        .scroll-horizontal::-webkit-scrollbar,
        .scroll-vertical::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .scroll-horizontal::-webkit-scrollbar-track,
        .scroll-vertical::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .scroll-horizontal::-webkit-scrollbar-thumb,
        .scroll-vertical::-webkit-scrollbar-thumb {
            background: #555555;
            border-radius: 6px;
        }

        .scroll-horizontal::-webkit-scrollbar-thumb:hover,
        .scroll-vertical::-webkit-scrollbar-thumb:hover {
            background: #777777;
        }

        .performance-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div class="main-areas-container"></div>

    <div class="performance-info" id="performance-info">
        FPS: <span id="fps">0</span><br>
        Render Zeit: <span id="render-time">0ms</span><br>
        Reservierungen: <span id="reservations-count">0</span><br>
        Zimmer: <span id="rooms-count">0</span>
    </div>

    <!-- Scripts -->
    <script src="timeline-unified.js"></script>
    <script>
        // Debug: Prüfe sofort nach dem Laden
        console.log('Nach Script-Tag: TimelineUnifiedRenderer =', typeof TimelineUnifiedRenderer);
        if (typeof TimelineUnifiedRenderer === 'undefined') {
            console.error('FEHLER: TimelineUnifiedRenderer wurde nicht geladen!');
        }

        // ===== GLOBAL VARIABLES =====
        let timelineRenderer = null; // Timeline-Renderer-Instanz

        // ===== FUNCTION DEFINITIONS (moved to top for onclick availability) =====

        // Echte Daten laden (API-Integration)
        async function loadRealData() {
            try {
                // Automatischer Datums-Bereich: now - 2 weeks bis now + 2 years
                const now = new Date();
                now.setHours(0, 0, 0, 0); // now = 2024-07-22 00:00:00
                const startDate = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
                const endDate = new Date(now.getTime() + (1 * 365 * 24 * 60 * 60 * 1000));

                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];

                console.log(`Loading REAL data from API: ${startDateStr} to ${endDateStr}`);

                // API-Aufruf für echte Daten
                const response = await fetch(`getZimmerplanData.php?start=${startDateStr}&end=${endDateStr}`);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                if (!result.success) {
                    throw new Error(result.error || 'API-Fehler');
                }

                console.log('API Response:', result);

                // Verarbeite Zimmer-Details zuerst
                roomDetails = result.data.room_details
                    ? result.data.room_details
                        .filter(item => item.room_id && item.start && item.end)
                        .map(item => ({
                            room_id: item.room_id,
                            guest_name: item.data ? item.data.guest_name : 'Unbekannt',
                            start: parseAPIDate(item.start),
                            end: parseAPIDate(item.end),
                            color: item.data ? item.data.color : '#3498db',
                            has_dog: item.data ? item.data.has_dog : false,
                            capacity: item.data ? item.data.capacity : 1,
                            data: item.data || {},
                            reservation_id: item.data ? item.data.res_id : null
                        }))
                    : [];

                // Verarbeite Master-Reservierungen - filtere bereits zugewiesene aus (verwende is_disposed Flag)
                reservations = result.data.timeline_items
                    ? result.data.timeline_items
                        .filter(item => item.content && item.start && item.end)
                        .filter(item => {
                            // Verwende das is_disposed Flag aus der API
                            const isDisposed = item.data && item.data.is_disposed;
                            return !isDisposed;
                        })
                        .map((item, index) => ({
                            id: item.id || index,
                            name: item.name || (item.data ? item.data.guest_name : item.content.replace(/<[^>]*>/g, '')),
                            nachname: item.nachname || '', // FIX: Direkt aus item nehmen, nicht aus data
                            vorname: item.vorname || '',   // FIX: Direkt aus item nehmen, nicht aus data
                            start: parseAPIDate(item.start),
                            end: parseAPIDate(item.end),
                            capacity: item.capacity || (item.data ? item.data.capacity : 1), // FIX: Aus item zuerst
                            arrangement_name: item.arrangement_name || item.arr_kbez || '', // FIX: Direkt aus item
                            arr_kbez: item.arr_kbez || '',  // FIX: Direkt aus item
                            has_dog: item.has_dog || item.hund || (item.data && item.data.has_dog) || false, // FIX: Mehrere Quellen
                            hund: item.hund || item.has_dog || false,
                            fullData: item.data
                        }))
                    : [];

                // Lade Zimmer-Daten
                const roomsResponse = await fetch('getRooms.php');
                const roomsResult = await roomsResponse.json();

                if (roomsResult.success) {
                    rooms = roomsResult.data || [];
                    // Sortiere Zimmer für konsistente Anzeige
                    rooms.sort((a, b) => {
                        const sortA = a.sort !== undefined ? a.sort : a.id;
                        const sortB = b.sort !== undefined ? b.sort : b.id;
                        return sortA - sortB;
                    });
                } else {
                    console.warn('Failed to load rooms, using fallback');
                    rooms = [
                        { id: 1, caption: 'Zimmer 1', capacity: 2, display_name: 'Zimmer 1 (2P)' },
                        { id: 2, caption: 'Zimmer 2', capacity: 4, display_name: 'Zimmer 2 (4P)' },
                        { id: 3, caption: 'Zimmer 3', capacity: 3, display_name: 'Zimmer 3 (3P)' }
                    ];
                }

                console.log(`Loaded REAL data: ${reservations.length} reservations, ${roomDetails.length} room details, ${rooms.length} rooms`);

                // Rendere Timeline mit echten Daten
                renderTimeline();

                console.log(`✅ Echte Daten geladen: ${reservations.length} Reservierungen, ${rooms.length} Zimmer`);

            } catch (error) {
                console.error('Fehler beim Laden der echten Daten:', error);
                // Bei Fehler: leere Timeline anzeigen
                reservations = [];
                roomDetails = [];
                rooms = [];
                renderTimeline();
            }
        }

        // API-Datum-Parser (kompatibel mit getZimmerplanData.php)
        function parseAPIDate(dateString) {
            if (!dateString) return new Date();

            dateString = dateString.trim();

            // ISO-Format (YYYY-MM-DD oder YYYY-MM-DD HH:MM:SS)
            if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) {
                return new Date(dateString);
            }

            // Deutsches Format (DD.MM.YYYY)
            if (/^\d{1,2}\.\d{1,2}\.\d{4}/.test(dateString)) {
                const parts = dateString.split('.');
                if (parts.length >= 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    return new Date(year, month, day, 12, 0, 0, 0);
                }
            }

            return new Date(dateString);
        }

        // Rendere Timeline (Canvas)
        function renderTimeline() {
            // Prüfe ob TimelineUnifiedRenderer verfügbar ist
            if (typeof TimelineUnifiedRenderer === 'undefined') {
                console.error('TimelineUnifiedRenderer ist nicht verfügbar. Prüfe, ob timeline-unified.js korrekt geladen wurde.');
                return;
            }

            // Prüfe ob Container existiert
            const container = document.querySelector('.main-areas-container');
            if (!container) {
                console.error('Container .main-areas-container nicht gefunden');
                return;
            }

            if (timelineRenderer) {
                console.log('Rendering timeline with unified renderer...');
                timelineRenderer.updateData(reservations, roomDetails, rooms);
            } else {
                console.log('Creating new unified timeline renderer...');
                timelineRenderer = new TimelineUnifiedRenderer('.main-areas-container');
                timelineRenderer.updateData(reservations, roomDetails, rooms);
            }
        }

        // ===== INITIALIZATION AND PERFORMANCE MONITORING =====

        // Performance Monitoring
        let fps = 0;
        let lastFrame = performance.now();
        let frameCount = 0;

        function updatePerformanceInfo() {
            const now = performance.now();
            frameCount++;

            if (now - lastFrame >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFrame = now;

                document.getElementById('fps').textContent = fps;
                document.getElementById('reservations-count').textContent = reservations.length;
                document.getElementById('rooms-count').textContent = rooms.length;
            }

            requestAnimationFrame(updatePerformanceInfo);
        }
        updatePerformanceInfo();

        // ===== VARIABLES AND INITIALIZATION =====

        // Globale Variablen für Kompatibilität
        let showDisposedReservations = true;

        // Initialisierung
        document.addEventListener('DOMContentLoaded', () => {
            // Automatisch echte Daten laden beim Seitenaufruf
            setTimeout(() => {
                console.log('Auto-loading REAL data on page load...');
                console.log('TimelineUnifiedRenderer verfügbar:', typeof TimelineUnifiedRenderer);

                // Versuche echte Daten zu laden
                loadRealData().catch(error => {
                    console.error('Auto-load failed:', error);
                });
            }, 100); // 100ms Verzögerung
        });
    </script>
</body>

</html>