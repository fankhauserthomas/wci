<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Sync Manager Konfiguration</title>
    <link rel="stylesheet" href="include/style.css">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status-box {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: black;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin: 5px 0;
        }

        .form-group input[type="text"] {
            width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .log-output {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            white-space: pre-wrap;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”„ Sync Manager Konfiguration</h1>
        <p>Verwalte die automatische Synchronisation zwischen Local und Remote Datenbank</p>

        <div class="grid">
            <div class="card">
                <h2>ğŸ“Š System Status</h2>
                <div id="syncStatus" class="status-box">Lade Status...</div>
                <button class="btn btn-primary" onclick="checkStatus()">Status aktualisieren</button>
            </div>

            <div class="card">
                <h2>âš™ï¸ Cron-Job Konfiguration</h2>
                <form id="cronForm">
                    <div class="form-group">
                        <h3>Sync-Intervall:</h3>
                        <label>
                            <input type="radio" name="cronInterval" value="disabled" checked>
                            ğŸš« Deaktiviert
                        </label>
                        <label>
                            <input type="radio" name="cronInterval" value="1">
                            âš¡ Jede Minute (nur fÃ¼r Tests!)
                        </label>
                        <label>
                            <input type="radio" name="cronInterval" value="5">
                            ï¿½ Alle 5 Minuten
                        </label>
                        <label>
                            <input type="radio" name="cronInterval" value="60">
                            ğŸ• Jede Stunde (empfohlen)
                        </label>
                        <label>
                            <input type="radio" name="cronInterval" value="custom">
                            ğŸ› ï¸ Custom:
                            <input type="text" name="customCron" placeholder="*/15 * * * *" style="width: 150px;">
                        </label>
                    </div>

                    <div class="form-group">
                        <h3>Zu synchronisierende Tabellen:</h3>
                        <label><input type="checkbox" name="tables[]" value="AV-ResNamen" checked> ğŸ‘¥ AV-ResNamen
                            (GÃ¤stedaten)</label>

                        <div
                            style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 10px 0; border-radius: 5px;">
                            <h4 style="color: #856404; margin-top: 0;">âš ï¸ KRITISCHE TABELLEN - VORSICHT!</h4>
                            <p style="color: #856404; margin: 5px 0;">Diese Tabellen enthalten kritische Reservierungs-
                                und Zimmerdaten. Aktivierung nur nach RÃ¼cksprache!</p>

                            <label style="margin-bottom: 10px;">
                                <input type="checkbox" name="dangerTables[]" value="AV-Res"
                                    onchange="confirmDangerousTable(this)">
                                ğŸ¨ AV-Res (Reservierungen) - <strong style="color: red;">KRITISCH!</strong>
                            </label>
                            <label style="margin-bottom: 10px;">
                                <input type="checkbox" name="dangerTables[]" value="AV_ResDet"
                                    onchange="confirmDangerousTable(this)">
                                ğŸ“‹ AV_ResDet (Reservierungs-Details) - <strong style="color: red;">KRITISCH!</strong>
                            </label>
                            <label style="margin-bottom: 10px;">
                                <input type="checkbox" name="dangerTables[]" value="zp_zimmer"
                                    onchange="confirmDangerousTable(this)">
                                ğŸ›ï¸ zp_zimmer (Zimmer-Daten) - <strong style="color: red;">KRITISCH!</strong>
                            </label>

                            <div style="margin-top: 10px;">
                                <label>
                                    <input type="checkbox" id="confirmDangerous" style="margin-right: 5px;">
                                    <strong style="color: red;">Ich bestÃ¤tige, dass ich die Risiken verstehe und die
                                        Berechtigung habe, diese Tabellen zu aktivieren.</strong>
                                </label>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-success" onclick="saveCronConfig()">ğŸ’¾ Konfiguration
                        speichern</button>
                </form>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>ğŸ§ª Manueller Sync & Test</h2>
                <button class="btn btn-primary" onclick="testSync()">ğŸ” Sync testen</button>
                <button class="btn btn-warning" onclick="forceSync()">âš¡ Force Sync (letzte Stunde)</button>
                <button class="btn btn-success" onclick="fullSync()">ğŸ”„ VollstÃ¤ndiger Sync</button>
                <div id="testResults"></div>
            </div>

            <div class="card">
                <h2>ğŸ“ˆ Sync Statistiken</h2>
                <div id="syncStats">Lade Statistiken...</div>
                <button class="btn btn-primary" onclick="loadStats()">ğŸ“Š Statistiken aktualisieren</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“œ Sync-Logs</h2>
            <div style="margin: 10px 0;">
                <button class="btn btn-primary" onclick="viewLogs()">ğŸ“„ Logs anzeigen</button>
                <button class="btn btn-warning" onclick="clearLogs()">ğŸ—‘ï¸ Logs lÃ¶schen</button>
                <button class="btn btn-success" onclick="downloadLogs()">ğŸ’¾ Logs herunterladen</button>
            </div>
            <div id="logOutput" class="log-output">Keine Logs geladen...</div>
        </div>

        <div class="card">
            <h2>ğŸ› ï¸ Erweiterte Funktionen</h2>
            <div style="margin: 10px 0;">
                <button class="btn btn-warning" onclick="checkTables()">ğŸ” Tabellen-Struktur prÃ¼fen</button>
                <button class="btn btn-primary" onclick="initializeQueues()">ğŸš€ Queue-Tabellen initialisieren</button>
                <button class="btn btn-danger" onclick="resetSync()"
                    onclick="return confirm('Wirklich alle Sync-Daten zurÃ¼cksetzen?')">
                    ğŸ”„ Sync zurÃ¼cksetzen
                </button>
            </div>
            <div id="advancedResults"></div>
        </div>
    </div>

    <script>
        let isLoading = false;

        function setLoading(loading) {
            isLoading = loading;
            document.body.classList.toggle('loading', loading);
        }

        async function apiCall(action, data = null, method = 'GET') {
            if (isLoading) return;
            setLoading(true);

            try {
                let url = `sync-config-api.php?action=${action}&t=${Date.now()}`;
                let options = { method };

                if (data && method === 'POST') {
                    if (data instanceof FormData) {
                        options.body = data;
                    } else {
                        options.headers = { 'Content-Type': 'application/json' };
                        options.body = JSON.stringify(data);
                    }
                }

                const response = await fetch(url, options);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                return result;

            } catch (error) {
                console.error('API Error:', error);
                return { success: false, error: error.message };
            } finally {
                setLoading(false);
            }
        }

        async function checkStatus() {
            const result = await apiCall('status');

            if (result && result.success) {
                const statusClass = result.allOk ? 'status-success' : 'status-warning';
                document.getElementById('syncStatus').className = `status-box ${statusClass}`;
                document.getElementById('syncStatus').innerHTML = `
                    <strong>ğŸ”— Remote DB:</strong> ${result.remoteConnected ? 'âœ… Verbunden' : 'âŒ Getrennt'}<br>
                    <strong>ğŸ“Š Queue Tables:</strong> ${result.queueTables ? 'âœ… VerfÃ¼gbar' : 'âŒ Nicht verfÃ¼gbar'}<br>
                    <strong>ğŸ• Letzter Sync:</strong> ${result.lastSync || 'â“ Unbekannt'}<br>
                    <strong>âš™ï¸ Cron Status:</strong> ${result.cronActive ? 'âœ… Aktiv' : 'âŒ Inaktiv'}<br>
                    <strong>ğŸ“ˆ Aktive Tabellen:</strong> ${result.activeTables?.join(', ') || 'Keine'}
                `;
            } else {
                document.getElementById('syncStatus').className = 'status-box status-error';
                document.getElementById('syncStatus').innerHTML = `âŒ Fehler: ${result?.error || 'Unbekannter Fehler'}`;
            }
        }

        function confirmDangerousTable(checkbox) {
            if (checkbox.checked) {
                const tableName = checkbox.value;
                const confirmCheckbox = document.getElementById('confirmDangerous');

                if (!confirmCheckbox.checked) {
                    alert(`âš ï¸ WARNUNG!\n\nSie versuchen die kritische Tabelle "${tableName}" zu aktivieren.\n\nBitte bestÃ¤tigen Sie zuerst, dass Sie die Risiken verstehen!`);
                    checkbox.checked = false;
                    return;
                }

                const confirmed = confirm(`ğŸš¨ LETZTE WARNUNG!\n\nSie aktivieren die Synchronisation fÃ¼r: ${tableName}\n\nDies kann zu Datenverlust oder Inkonsistenzen fÃ¼hren!\n\nSind Sie ABSOLUT SICHER?\n\n(Diese Aktion sollte nur von autorisierten Administratoren durchgefÃ¼hrt werden)`);

                if (!confirmed) {
                    checkbox.checked = false;
                }
            }
        }

        async function saveCronConfig() {
            const formData = new FormData(document.getElementById('cronForm'));

            // FÃ¼ge dangerous tables zu normalen tables hinzu wenn bestÃ¤tigt
            const dangerousTables = formData.getAll('dangerTables[]');
            const confirmDangerous = document.getElementById('confirmDangerous').checked;

            if (dangerousTables.length > 0 && !confirmDangerous) {
                alert('âš ï¸ Sie mÃ¼ssen die RisikobestÃ¤tigung aktivieren um kritische Tabellen zu verwenden!');
                return;
            }

            // Merge tables
            dangerousTables.forEach(table => {
                formData.append('tables[]', table);
            });

            const result = await apiCall('saveCron', formData, 'POST');

            if (result.success) {
                alert(`âœ… Konfiguration gespeichert!\nCron-Job wurde ${result.action}\n\nAusdruck: ${result.cronExpression || 'N/A'}`);
                checkStatus(); // Status aktualisieren
            } else {
                alert(`âŒ Fehler: ${result.error}`);
            }
        }

        async function testSync() {
            document.getElementById('testResults').innerHTML = '<div class="status-box status-warning">ğŸ” Teste Sync...</div>';

            const result = await apiCall('test');

            const resultClass = result.success ? 'status-success' : 'status-error';
            document.getElementById('testResults').innerHTML = `
                <div class="status-box ${resultClass}">
                    <h4>ğŸ§ª Test-Ergebnis:</h4>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                </div>
            `;
        }

        async function forceSync() {
            document.getElementById('testResults').innerHTML = '<div class="status-box status-warning">âš¡ Force Sync lÃ¤uft...</div>';

            const result = await apiCall('force');

            const resultClass = result.success ? 'status-success' : 'status-error';
            document.getElementById('testResults').innerHTML = `
                <div class="status-box ${resultClass}">
                    <h4>âš¡ Force Sync Ergebnis:</h4>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                </div>
            `;
        }

        async function fullSync() {
            if (!confirm('VollstÃ¤ndigen Sync starten? Das kann einige Minuten dauern.')) return;

            document.getElementById('testResults').innerHTML = '<div class="status-box status-warning">ğŸ”„ VollstÃ¤ndiger Sync lÃ¤uft...</div>';

            const result = await apiCall('fullSync');

            const resultClass = result.success ? 'status-success' : 'status-error';
            document.getElementById('testResults').innerHTML = `
                <div class="status-box ${resultClass}">
                    <h4>ğŸ”„ VollstÃ¤ndiger Sync Ergebnis:</h4>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                </div>
            `;
        }

        async function loadStats() {
            const result = await apiCall('stats');

            if (result && result.success) {
                document.getElementById('syncStats').innerHTML = `
                    <div class="status-box status-success">
                        <strong>ğŸ“Š Sync Statistiken:</strong><br>
                        ğŸ“ˆ Syncs heute: ${result.stats.syncsToday || 0}<br>
                        ğŸ“ˆ Syncs diese Woche: ${result.stats.syncsThisWeek || 0}<br>
                        ğŸ“‹ Records heute: ${result.stats.recordsToday || 0}<br>
                        âš ï¸ Fehler heute: ${result.stats.errorsToday || 0}<br>
                        ğŸ• Durchschnittliche Dauer: ${result.stats.avgDuration || 'N/A'}s
                    </div>
                `;
            } else {
                document.getElementById('syncStats').innerHTML = `
                    <div class="status-box status-error">âŒ Fehler beim Laden der Statistiken: ${result?.error || 'Unbekannter Fehler'}</div>
                `;
            }
        }

        async function viewLogs() {
            const result = await apiCall('logs');

            if (result.success) {
                document.getElementById('logOutput').innerHTML = result.logs || 'Keine Logs verfÃ¼gbar';
                document.getElementById('logOutput').scrollTop = document.getElementById('logOutput').scrollHeight;
            } else {
                document.getElementById('logOutput').innerHTML = `Fehler beim Laden der Logs: ${result.error}`;
            }
        }

        async function clearLogs() {
            if (!confirm('Wirklich alle Logs lÃ¶schen?')) return;

            const result = await apiCall('clearLogs', null, 'POST');

            if (result.success) {
                document.getElementById('logOutput').innerHTML = 'Logs wurden gelÃ¶scht';
                alert('âœ… Logs erfolgreich gelÃ¶scht');
            } else {
                alert(`âŒ Fehler beim LÃ¶schen: ${result.error}`);
            }
        }

        async function downloadLogs() {
            window.open('sync-config-api.php?action=downloadLogs', '_blank');
        }

        async function checkTables() {
            document.getElementById('advancedResults').innerHTML = '<div class="status-box status-warning">ğŸ” PrÃ¼fe Tabellen...</div>';

            const result = await apiCall('checkTables');

            const resultClass = result.success ? 'status-success' : 'status-error';
            document.getElementById('advancedResults').innerHTML = `
                <div class="status-box ${resultClass}">
                    <h4>ğŸ” Tabellen-PrÃ¼fung:</h4>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                </div>
            `;
        }

        async function initializeQueues() {
            if (!confirm('Queue-Tabellen initialisieren? Bestehende Daten bleiben erhalten.')) return;

            document.getElementById('advancedResults').innerHTML = '<div class="status-box status-warning">ğŸš€ Initialisiere Queues...</div>';

            const result = await apiCall('initQueues', null, 'POST');

            const resultClass = result.success ? 'status-success' : 'status-error';
            document.getElementById('advancedResults').innerHTML = `
                <div class="status-box ${resultClass}">
                    <h4>ğŸš€ Queue-Initialisierung:</h4>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                </div>
            `;

            if (result.success) {
                checkStatus(); // Status aktualisieren
            }
        }

        async function resetSync() {
            if (!confirm('ACHTUNG: Alle Sync-Queue-Daten werden gelÃ¶scht!\n\nDies setzt die Synchronisation komplett zurÃ¼ck.\nFortfahren?')) return;

            document.getElementById('advancedResults').innerHTML = '<div class="status-box status-warning">ğŸ”„ Setze Sync zurÃ¼ck...</div>';

            const result = await apiCall('resetSync', null, 'POST');

            const resultClass = result.success ? 'status-success' : 'status-error';
            document.getElementById('advancedResults').innerHTML = `
                <div class="status-box ${resultClass}">
                    <h4>ğŸ”„ Sync-Reset:</h4>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                </div>
            `;

            if (result.success) {
                checkStatus(); // Status aktualisieren
            }
        }

        // Auto-refresh Status alle 30 Sekunden
        setInterval(checkStatus, 30000);

        // Initial laden
        checkStatus();
        loadStats();
    </script>
</body>

</html>