<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reservierung anzeigen</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="reservation.css">
  <link rel="stylesheet" href="css/navigation.css">
  <link rel="stylesheet" href="css/navigation-integration.css">
</head>

<body>
  <!-- Navigation wird durch JavaScript eingefügt -->

  <main class="main-content">
    <!-- Reservation Header (grün) -->
    <div id="resHeader" class="res-header">
      <div class="header-content">
        <div class="header-info">
          <!-- Wird durch JavaScript befüllt -->
        </div>
        <div class="header-buttons">
          <button id="editBtn" class="header-btn">Bearbeiten</button>
          <button id="emailBtn" class="header-btn header-btn-blue">E-Mail</button>
          <button id="stornoBtn" class="header-btn header-btn-orange">Storno</button>
          <button id="deleteReservationBtn" class="header-btn header-btn-danger">Löschen</button>
        </div>
      </div>
    </div>

    <!-- Action Bar -->
    <div id="actionBar" class="action-bar">
      <button id="deleteBtn">Löschen</button>
      <button id="printBtn">Drucken</button>
      <button id="arrangementBtn" class="btn-arrangement">Arrangement…</button>
      <button id="dietBtn" class="btn-diet">Diät…</button>
      <button id="bulkCheckinBtn" class="btn-bulk" disabled>Bulk Check-in</button>
      <button id="bulkCheckoutBtn" class="btn-bulk" disabled>Bulk Check-out</button>
      <button id="backBtn">Zurück zur Liste</button>
    </div>

    <!-- Namen-Tabelle -->
    <div class="table-container">
      <table id="namesTable" class="names-list">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Name</th>
            <th>Details</th>
            <th>Alter</th>
            <th>Bemerkung</th>
            <th>BF</th>
            <th>Arr</th>
            <th>Diät</th>
            <th>No-Show</th>
            <th>Check-in</th>
            <th>Check-out</th>
          </tr>
        </thead>
        <tbody>
          <!-- Wird durch JavaScript befüllt -->
        </tbody>
      </table>
    </div>

    <!-- Arrangement Modal -->
    <div id="arrangementModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <span id="closeArrModal" class="modal-close">&times;</span>
        <h2>Arrangement wählen</h2>
        <div id="arrButtonsContainer" class="arr-buttons"></div>
      </div>
    </div>

    <!-- Diet Modal -->
    <div id="dietModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <span id="closeDietModal" class="modal-close">&times;</span>
        <h2>Diät wählen</h2>
        <div id="dietButtonsContainer" class="arr-buttons"></div>
      </div>
    </div>

    <!-- Namen hinzufügen -->
    <details id="addNamesDetails">
      <summary>Namen hinzufügen</summary>
      <div class="import-format-selector">
        <label for="importFormat">Format:</label>
        <select id="importFormat">
          <option value="firstname-lastname">Vorname Nachname</option>
          <option value="lastname-firstname">Nachname Vorname</option>
        </select>
      </div>
      <textarea id="newNamesTextarea" rows="5" placeholder="pro Zeile ein Eintrag"></textarea>
      <button id="importNamesBtn">Importieren</button>
    </details>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <span class="modal-close" id="confirmModalClose">&times;</span>
        <h3 id="confirmModalTitle">Bestätigung</h3>
        <div id="confirmModalMessage"></div>
        <div id="confirmModalQuestion"></div>
        <div class="modal-buttons">
          <button id="confirmModalYes" class="btn-confirm">Ja</button>
          <button id="confirmModalNo" class="btn-cancel">Nein</button>
        </div>
      </div>
    </div>

    <!-- Name Correction Modal -->
    <div id="nameCorrectionModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <span class="modal-close" id="nameCorrectionModalClose">&times;</span>
        <h3>Namen-Korrektur vorgeschlagen</h3>
        <p>Es wurde erkannt, dass in einem Namensfeld mehrere Namen stehen. Möchten Sie diese aufteilen?</p>

        <div id="nameCorrectionOptions" style="margin: 20px 0;">
          <!-- Options will be populated by JavaScript -->
        </div>

        <div style="margin: 15px 0;">
          <label for="customNameSplit" style="display: block; margin-bottom: 5px; font-weight: 600;">Eigene
            Aufteilung:</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <div>
              <label for="customVorname" style="font-size: 0.9rem;">VN:</label>
              <input type="text" id="customVorname" placeholder="Vorname"
                style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 120px;">
            </div>
            <div>
              <label for="customNachname" style="font-size: 0.9rem;">NN:</label>
              <input type="text" id="customNachname" placeholder="Nachname"
                style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 120px;">
            </div>
          </div>
        </div>

        <div class="modal-buttons">
          <button id="nameCorrectionApply" class="btn-confirm">Anwenden</button>
          <button id="nameCorrectionSkip" class="btn-cancel">Überspringen</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Connection Status -->
  <div class="connection-status" id="connection-indicator">
    <div class="status-dot"></div>
    <span class="status-text">Verbindung prüfen...</span>
  </div>

  <!-- Navigation System -->
  <script src="js/navigation.js"></script>
  <script src="js/email-utils.js"></script>
  <script src="js/http-utils.js"></script>
  <script src="js/loading-overlay.js"></script>
  <script src="reservation.js"></script>

  <script>
    // Swipe-Navigation für Touch-Geräte
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let swipeIndicator = null;

    // Touch-Events nur für Touch-Geräte aktivieren
    if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
      document.addEventListener('touchstart', function (e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });

      document.addEventListener('touchmove', function (e) {
        const currentX = e.changedTouches[0].screenX;
        const currentY = e.changedTouches[0].screenY;
        const deltaX = currentX - touchStartX;
        const deltaY = currentY - touchStartY;

        // Nur bei horizontalem Swipe nach rechts und minimaler vertikaler Bewegung
        if (deltaX > 30 && Math.abs(deltaY) < 50) {

          // Swipe-Indikator erstellen (falls noch nicht vorhanden)
          if (!swipeIndicator) {
            swipeIndicator = document.createElement('div');
            swipeIndicator.style.cssText = `
              position: fixed;
              top: 50%;
              right: 20px;
              transform: translateY(-50%);
              background: rgba(46, 204, 113, 0.9);
              color: white;
              padding: 12px 18px;
              border-radius: 25px;
              font-size: 14px;
              font-weight: bold;
              z-index: 10000;
              pointer-events: none;
              transition: all 0.2s ease;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
              display: flex;
              align-items: center;
              gap: 8px;
            `;
            swipeIndicator.innerHTML = 'Zurück <span style="font-size: 18px;">→</span>';
            document.body.appendChild(swipeIndicator);
          }

          // Opacity und Skalierung basierend auf Swipe-Distanz
          const progress = Math.min(Math.abs(deltaX) / 100, 1);
          const opacity = Math.max(0.3, progress);
          const scale = 0.8 + (progress * 0.2);

          swipeIndicator.style.opacity = opacity;
          swipeIndicator.style.transform = `translateY(-50%) scale(${scale})`;

          // Verhindere Scroll während Swipe
          if (progress > 0.3) {
            e.preventDefault();
          }
        }
      }, { passive: false });

      document.addEventListener('touchend', function (e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;

        // Indikator entfernen
        if (swipeIndicator) {
          swipeIndicator.style.opacity = '0';
          swipeIndicator.style.transform = 'translateY(-50%) scale(0.5)';
          setTimeout(() => {
            if (swipeIndicator) {
              swipeIndicator.remove();
              swipeIndicator = null;
            }
          }, 200);
        }

        // Swipe-Geste auswerten
        handleSwipeGesture();
      }, { passive: true });
    }

    function handleSwipeGesture() {
      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;
      const absDeltaX = Math.abs(deltaX);
      const absDeltaY = Math.abs(deltaY);
      const minSwipeDistance = window.screen.width * 0.2; // 20% der Bildschirmbreite

      // Mindest-Swipe-Distanz (20% Bildschirmbreite) und horizontaler Swipe dominiert
      if (absDeltaX > minSwipeDistance && absDeltaX > absDeltaY * 1.5) {

        // Swipe nach rechts = zurück zur vorherigen Seite
        if (deltaX > 0) {
          console.log('Swipe right detected - navigating back');

          // NavigationSystem verwenden wenn verfügbar
          if (typeof NavigationSystem !== 'undefined' && NavigationSystem.goBack) {
            NavigationSystem.goBack();
          } else {
            // Fallback: Browser-History oder zur Reservierungsliste
            if (document.referrer && document.referrer.includes('/wci/')) {
              window.history.back();
            } else {
              window.location.href = 'reservierungen.html';
            }
          }
        }
      }
    }

    // Navigation und Initialisierung
    document.addEventListener('DOMContentLoaded', function () {
      // Navigation Setup
      if (typeof NavigationSystem !== 'undefined') {
        NavigationSystem.setupNavigation();
        console.log('✅ Navigation setup completed');
      } else {
        console.warn('⚠️ NavigationSystem not found');
      }

      // Connection Status
      const indicator = document.getElementById('connection-indicator');
      if (indicator && window.connectionMonitor && window.updateConnectionStatus) {
        window.updateConnectionStatus();
      }

      // Header-Daten beim Laden aktualisieren
      refreshHeaderData();

      console.log('✅ Reservation page initialized');
      console.log('✅ Swipe navigation enabled for touch devices');
    });

    // Seitenfokus - Header aktualisieren wenn von anderen Seiten zurückgekehrt
    window.addEventListener('focus', function () {
      console.log('🔄 Page focus - refreshing header data...');
      refreshHeaderData();
    });

    // Sichtbarkeit - Header aktualisieren wenn Seite wieder sichtbar wird
    document.addEventListener('visibilitychange', function () {
      if (!document.hidden) {
        console.log('👁️ Page visible - refreshing header data...');
        refreshHeaderData();
      }
    });

    // Header-Daten neu laden
    function refreshHeaderData() {
      // Reservierungs-ID aus URL holen
      const urlParams = new URLSearchParams(window.location.search);
      const resId = urlParams.get('id');

      if (!resId) {
        console.warn('⚠️ Keine Reservierungs-ID in URL gefunden');
        return;
      }

      console.log('🔄 Lade Header-Daten für Reservierung ID:', resId);

      // Progressive Retry-Logik für reservation.js Funktionen
      let retryCount = 0;
      const maxRetries = 5;
      const retryDelay = 200;

      const tryLoadReservationData = () => {
        if (typeof window.loadReservationData === 'function') {
          console.log('✅ Verwende loadReservationData() aus reservation.js');
          window.loadReservationData().then(() => {
            console.log('✅ Header-Update über loadReservationData abgeschlossen');
          }).catch(error => {
            console.error('❌ Fehler beim Header-Update:', error);
          });
        } else if (retryCount < maxRetries) {
          retryCount++;
          console.log(`⏳ loadReservationData noch nicht verfügbar (Versuch ${retryCount}/${maxRetries}), wiederhole in ${retryDelay}ms...`);
          setTimeout(tryLoadReservationData, retryDelay);
        } else {
          console.warn('⚠️ loadReservationData nach mehreren Versuchen nicht verfügbar, verwende Fallback');
          loadHeaderDataDirectly(resId);
        }
      };

      tryLoadReservationData();
    }

    // Direkte Header-Daten-Abfrage über reservation.js loadReservationData
    async function loadHeaderDataDirectly(resId) {
      try {
        console.log('📡 Lade Header-Daten über reservation.js loadReservationData...');

        // reservation.js loadReservationData Funktion aufrufen wenn verfügbar
        if (typeof loadReservationData === 'function') {
          console.log('✅ Verwende loadReservationData() aus reservation.js');
          await loadReservationData();
          console.log('✅ Header-Update über loadReservationData abgeschlossen');
        } else {
          console.log('⚠️ loadReservationData nicht gefunden, verwende Fallback');

          // Fallback: Direkte API-Abfrage
          const response = window.HttpUtils
            ? await HttpUtils.requestJson(`getReservationDetails.php?id=${resId}`, {}, { retries: 2, timeout: 8000 })
            : await fetch(`getReservationDetails.php?id=${resId}`).then(r => r.json());

          if (response) {
            console.log('✅ Header-Daten erfolgreich geladen (Fallback):', response);
            updateHeaderDirectly(response);
          } else {
            console.warn('⚠️ Keine Daten von getReservationDetails.php erhalten');
          }
        }
      } catch (error) {
        console.error('❌ Fehler beim Laden der Header-Daten:', error);
      }
    }

    // Direkter DOM-Update falls keine passende Funktion gefunden wird
    function updateHeaderDirectly(data) {
      console.log('🔧 Führe direkten DOM-Update durch...');

      // Header-Farbe basierend auf Invoice-Status setzen
      if (data.invoice !== undefined) {
        const headerElement = document.getElementById('resHeader');
        if (headerElement) {
          const color = data.invoice ? '#B8860B' : '#2d8f4f'; // Dark Gold : Dark Green
          document.documentElement.style.setProperty('--res-header-bg', color, 'important');
          console.log('🎨 Header-Farbe direkt gesetzt:', data.invoice ? 'DARK GOLD' : 'DARK GREEN');
        }
      }

      // Header-Text aktualisieren falls vorhanden
      const headerInfo = document.querySelector('.header-info');
      if (headerInfo && data) {
        // Hier können weitere DOM-Updates eingefügt werden
        console.log('📝 Header-Info-Element gefunden - bereit für Updates');
      }
    }
  </script>
</body>

</html>