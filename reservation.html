<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reservierung anzeigen</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="reservation.css">
  <link rel="stylesheet" href="css/navigation.css">
  <link rel="stylesheet" href="css/navigation-integration.css">
</head>

<body>
  <!-- Navigation wird durch JavaScript eingef√ºgt -->

  <main class="main-content">
    <!-- Reservation Header (gr√ºn) -->
    <div id="resHeader" class="res-header">
      <div class="header-content">
        <div class="header-info">
          <!-- Wird durch JavaScript bef√ºllt -->
        </div>
        <div class="header-arrangements" id="headerArrangements">
          <!-- HP Arrangement Details werden hier angezeigt -->
          <div class="header-arr-title">HP Arrangements</div>
          <div class="header-arr-content" id="headerArrContent">
            <div class="loading-arr">Arrangements laden...</div>
          </div>
        </div>
        <div class="header-buttons">
          <button id="editBtn" class="header-btn">Bearbeiten</button>
          <button id="addNamesBtn" class="header-btn">Namen+</button>
          <button id="emailBtn" class="header-btn header-btn-blue">E-Mail</button>
          <button id="stornoBtn" class="header-btn header-btn-orange">Storno</button>
          <button id="deleteReservationBtn" class="header-btn header-btn-danger">L√∂schen</button>
        </div>
      </div>
    </div>

    <!-- Action Bar -->
    <div id="actionBar" class="action-bar">
      <button id="deleteBtn">L√∂schen</button>
      <button id="printBtn">Drucken</button>
      <button id="arrangementBtn" class="btn-arrangement">Arrangement‚Ä¶</button>
      <button id="dietBtn" class="btn-diet">Di√§t‚Ä¶</button>
      <button id="bulkCheckinBtn" class="btn-bulk" disabled>Bulk Check-in</button>
      <button id="bulkCheckoutBtn" class="btn-bulk" disabled>Bulk Check-out</button>
      <button id="backBtn">Zur√ºck zur Liste</button>
    </div>

    <!-- Namen-Tabelle -->
    <div class="table-container">
      <table id="namesTable" class="names-list">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Name</th>
            <th>Details</th>
            <th>Alter</th>
            <th>Bemerkung</th>
            <th>BF</th>
            <th>Arr</th>
            <th>Di√§t</th>
            <th>No-Show</th>
            <th>Check-in</th>
            <th>Check-out</th>
          </tr>
        </thead>
        <tbody>
          <!-- Wird durch JavaScript bef√ºllt -->
        </tbody>
      </table>
    </div>

    <!-- Arrangement Modal -->
    <div id="arrangementModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <span id="closeArrModal" class="modal-close">&times;</span>
        <h2>Arrangement w√§hlen</h2>
        <div id="arrButtonsContainer" class="arr-buttons"></div>
      </div>
    </div>

    <!-- Diet Modal -->
    <div id="dietModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <span id="closeDietModal" class="modal-close">&times;</span>
        <h2>Di√§t w√§hlen</h2>
        <div id="dietButtonsContainer" class="arr-buttons"></div>
      </div>
    </div>

    <!-- Namen hinzuf√ºgen Modal -->
    <div id="addNamesModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-add-names">
        <span class="modal-close" id="addNamesModalClose">&times;</span>
        <h3>Namen hinzuf√ºgen</h3>
        <p>F√ºgen Sie neue Namen zur Reservierung hinzu. Pro Zeile ein Name:</p>

        <div class="import-format-selector">
          <label for="importFormat">Format:</label>
          <select id="importFormat">
            <option value="firstname-lastname">Vorname Nachname</option>
            <option value="lastname-firstname">Nachname Vorname</option>
          </select>
        </div>

        <textarea id="newNamesTextarea" placeholder="pro Zeile ein Eintrag"></textarea>

        <div class="modal-buttons">
          <button id="importNamesBtn" class="btn-confirm">Namen hinzuf√ºgen</button>
          <button id="addNamesCancel" class="btn-cancel">Abbrechen</button>
        </div>
      </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <span class="modal-close" id="confirmModalClose">&times;</span>
        <h3 id="confirmModalTitle">Best√§tigung</h3>
        <div id="confirmModalMessage"></div>
        <div id="confirmModalQuestion"></div>
        <div class="modal-buttons">
          <button id="confirmModalYes" class="btn-confirm">Ja</button>
          <button id="confirmModalNo" class="btn-cancel">Nein</button>
        </div>
      </div>
    </div>

    <!-- Name Correction Modal -->
    <div id="nameCorrectionModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <span class="modal-close" id="nameCorrectionModalClose">&times;</span>
        <h3>Namen-Korrektur vorgeschlagen</h3>
        <p>Es wurde erkannt, dass in einem Namensfeld mehrere Namen stehen. M√∂chten Sie diese aufteilen?</p>

        <div id="nameCorrectionOptions" style="margin: 20px 0;">
          <!-- Options will be populated by JavaScript -->
        </div>

        <div style="margin: 15px 0;">
          <label for="customNameSplit" style="display: block; margin-bottom: 5px; font-weight: 600;">Eigene
            Aufteilung:</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <div>
              <label for="customVorname" style="font-size: 0.9rem;">VN:</label>
              <input type="text" id="customVorname" placeholder="Vorname"
                style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 120px;">
            </div>
            <div>
              <label for="customNachname" style="font-size: 0.9rem;">NN:</label>
              <input type="text" id="customNachname" placeholder="Nachname"
                style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 120px;">
            </div>
          </div>
        </div>

        <div class="modal-buttons">
          <button id="nameCorrectionApply" class="btn-confirm">Anwenden</button>
          <button id="nameCorrectionSkip" class="btn-cancel">√úberspringen</button>
        </div>
      </div>
    </div>

    <!-- Number Pad Modal -->
    <div id="numberPadModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content number-pad-modal">
        <span class="modal-close" id="numberPadClose">&times;</span>
        <h3>Anzahl eingeben</h3>

        <div class="number-display">
          <input type="text" id="numberDisplay" readonly value="1">
        </div>

        <div class="number-pad">
          <button class="num-btn" data-num="1">1</button>
          <button class="num-btn" data-num="2">2</button>
          <button class="num-btn" data-num="3">3</button>
          <button class="num-btn" data-num="4">4</button>
          <button class="num-btn" data-num="5">5</button>
          <button class="num-btn" data-num="6">6</button>
          <button class="num-btn" data-num="7">7</button>
          <button class="num-btn" data-num="8">8</button>
          <button class="num-btn" data-num="9">9</button>
          <button class="num-btn clear-btn" data-action="clear">C</button>
          <button class="num-btn" data-num="0">0</button>
          <button class="num-btn backspace-btn" data-action="backspace">‚å´</button>
        </div>

        <div class="number-pad-actions">
          <button id="numberPadCancel" class="btn-cancel">Abbrechen</button>
          <button id="numberPadOk" class="btn-confirm">OK</button>
        </div>
      </div>
    </div>

    <!-- Tisch-Uebersicht Modal -->
    <div id="tischUebersichtModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-tisch-uebersicht">
        <span class="modal-close" id="tischUebersichtClose">&times;</span>
        <h3>Tisch√ºbersicht - Reservierung</h3>
        <div class="iframe-container">
          <iframe id="tischUebersichtIframe" src="" style="width: 100%; height: 600px; border: none;"></iframe>
        </div>
      </div>
    </div>
  </main>

  <!-- Connection Status -->
  <div class="connection-status" id="connection-indicator">
    <div class="status-dot"></div>
    <span class="status-text">Verbindung pr√ºfen...</span>
  </div>

  <!-- Navigation System -->
  <script src="js/navigation.js"></script>
  <script src="js/email-utils.js"></script>
  <script src="js/http-utils.js"></script>
  <script src="js/loading-overlay.js"></script>
  <script src="auto-barcode-scanner.js"></script>
  <script src="reservation.js"></script>

  <script>
    // Swipe-Navigation f√ºr Touch-Ger√§te
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let swipeIndicator = null;

    // Touch-Events nur f√ºr Touch-Ger√§te aktivieren
    if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
      document.addEventListener('touchstart', function (e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });

      document.addEventListener('touchmove', function (e) {
        const currentX = e.changedTouches[0].screenX;
        const currentY = e.changedTouches[0].screenY;
        const deltaX = currentX - touchStartX;
        const deltaY = currentY - touchStartY;

        // Nur bei horizontalem Swipe nach rechts und minimaler vertikaler Bewegung
        if (deltaX > 30 && Math.abs(deltaY) < 50) {

          // Swipe-Indikator erstellen (falls noch nicht vorhanden)
          if (!swipeIndicator) {
            swipeIndicator = document.createElement('div');
            swipeIndicator.style.cssText = `
              position: fixed;
              top: 50%;
              right: 20px;
              transform: translateY(-50%);
              background: rgba(46, 204, 113, 0.9);
              color: white;
              padding: 12px 18px;
              border-radius: 25px;
              font-size: 14px;
              font-weight: bold;
              z-index: 10000;
              pointer-events: none;
              transition: all 0.2s ease;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
              display: flex;
              align-items: center;
              gap: 8px;
            `;
            swipeIndicator.innerHTML = 'Zur√ºck <span style="font-size: 18px;">‚Üí</span>';
            document.body.appendChild(swipeIndicator);
          }

          // Opacity und Skalierung basierend auf Swipe-Distanz
          const progress = Math.min(Math.abs(deltaX) / 100, 1);
          const opacity = Math.max(0.3, progress);
          const scale = 0.8 + (progress * 0.2);

          swipeIndicator.style.opacity = opacity;
          swipeIndicator.style.transform = `translateY(-50%) scale(${scale})`;

          // Verhindere Scroll w√§hrend Swipe
          if (progress > 0.3) {
            e.preventDefault();
          }
        }
      }, { passive: false });

      document.addEventListener('touchend', function (e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;

        // Indikator entfernen
        if (swipeIndicator) {
          swipeIndicator.style.opacity = '0';
          swipeIndicator.style.transform = 'translateY(-50%) scale(0.5)';
          setTimeout(() => {
            if (swipeIndicator) {
              swipeIndicator.remove();
              swipeIndicator = null;
            }
          }, 200);
        }

        // Swipe-Geste auswerten
        handleSwipeGesture();
      }, { passive: true });
    }

    function handleSwipeGesture() {
      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;
      const absDeltaX = Math.abs(deltaX);
      const absDeltaY = Math.abs(deltaY);
      const minSwipeDistance = window.screen.width * 0.2; // 20% der Bildschirmbreite

      // Mindest-Swipe-Distanz (20% Bildschirmbreite) und horizontaler Swipe dominiert
      if (absDeltaX > minSwipeDistance && absDeltaX > absDeltaY * 1.5) {

        // Swipe nach rechts = zur√ºck zur vorherigen Seite
        if (deltaX > 0) {
          console.log('Swipe right detected - navigating back');

          // NavigationSystem verwenden wenn verf√ºgbar
          if (typeof NavigationSystem !== 'undefined' && NavigationSystem.goBack) {
            NavigationSystem.goBack();
          } else {
            // Fallback: Browser-History oder zur Reservierungsliste
            if (document.referrer && document.referrer.includes('/wci/')) {
              window.history.back();
            } else {
              window.location.href = 'reservierungen.html';
            }
          }
        }
      }
    }

    // Navigation und Initialisierung
    document.addEventListener('DOMContentLoaded', function () {
      // Navigation Setup
      if (typeof NavigationSystem !== 'undefined') {
        NavigationSystem.setupNavigation();
        console.log('‚úÖ Navigation setup completed');
      } else {
        console.warn('‚ö†Ô∏è NavigationSystem not found');
      }

      // Connection Status
      const indicator = document.getElementById('connection-indicator');
      if (indicator && window.connectionMonitor && window.updateConnectionStatus) {
        window.updateConnectionStatus();
      }

      // Pr√ºfe ob reservation.js bereits Daten l√§dt
      if (window.reservationJsLoading || window.currentReservationData) {
        console.log('üö´ reservation.js already loading/loaded, skipping HTML initialization');
        return;
      }

      // Globales Flag setzen um doppelte Aufrufe zu verhindern
      window.headerDataLoadInitiated = true;
      window.htmlInitializationActive = true;

      // Warte kurz ab ob reservation.js sich meldet
      setTimeout(() => {
        if (!window.reservationJsLoading && !window.currentReservationData) {
          console.log('‚úÖ HTML startet Header-Load nach Wartezeit');
          refreshHeaderData();
        } else {
          console.log('üö´ reservation.js hat sich gemeldet, HTML √ºberspringt Load');
        }
        window.htmlInitializationActive = false;
      }, 50);

      console.log('‚úÖ Reservation page initialized');
      console.log('‚úÖ Swipe navigation enabled for touch devices');
    });

    // Debounce-Variablen f√ºr Header-Refresh
    let headerRefreshTimeout = null;
    let isHeaderRefreshing = false;
    let lastFocusTime = 0;
    let wasHidden = false;

    // Optimierte Event Listener - immer bei Fokus-Wechsel aktualisieren
    window.addEventListener('focus', function () {
      const now = Date.now();
      console.log('üîÑ Page focus detected - force refreshing header data...');
      // Forciere Header-Update bei Focus (wichtig nach ReservationDetails √Ñnderungen)
      forceHeaderRefresh();
      lastFocusTime = now;
    });

    // Visibility Change - immer bei Tab-Wechsel aktualisieren
    document.addEventListener('visibilitychange', function () {
      if (document.hidden) {
        wasHidden = true;
      } else if (wasHidden) {
        console.log('üëÅÔ∏è Page visible (after being hidden) - force refreshing header data...');
        // Forciere Header-Update nach Tab-Wechsel
        forceHeaderRefresh();
        wasHidden = false;
      }
    });

    // PageShow Event - wichtig f√ºr Navigation zur√ºck von anderen Seiten
    window.addEventListener('pageshow', function (event) {
      // Besonders wichtig wenn von Browser-Cache geladen (bfcache)
      if (event.persisted) {
        console.log('üîÑ Page restored from cache - force refreshing header data...');
        forceHeaderRefresh();
      }
    });

    // Custom Event f√ºr Invoice Status √Ñnderungen
    window.addEventListener('invoiceStatusChanged', function (event) {
      console.log('üí∞ Invoice status changed detected:', event.detail);
      // Forciere sofortiges Header-Update bei Invoice-√Ñnderung
      forceHeaderRefresh();
    });

    // Force Header Refresh - umgeht alle Koordinations- und Debounce-Mechanismen
    function forceHeaderRefresh() {
      console.log('üöÄ FORCE Header Refresh - bypassing all coordination');

      // Reset aller Flags
      isHeaderRefreshing = false;
      window.reservationJsLoading = false;

      // L√∂sche vorherige Timeouts
      if (headerRefreshTimeout) {
        clearTimeout(headerRefreshTimeout);
      }

      // Direkte Ausf√ºhrung ohne Debouncing
      performForceHeaderRefresh();
    }

    async function performForceHeaderRefresh() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const resId = urlParams.get('id');

        if (!resId) {
          console.warn('‚ö†Ô∏è Keine Reservierungs-ID in URL gefunden');
          return;
        }

        console.log('üöÄ FORCE Lade Header-Daten f√ºr Reservierung ID:', resId);

        // Direkt reservation.js loadReservationData aufrufen wenn verf√ºgbar
        if (typeof window.loadReservationData === 'function') {
          console.log('‚úÖ FORCE Verwende loadReservationData() aus reservation.js');
          await window.loadReservationData();
          console.log('‚úÖ FORCE Header-Update √ºber loadReservationData abgeschlossen');
        } else {
          console.log('‚ö†Ô∏è loadReservationData nicht verf√ºgbar, verwende Fallback');

          // Fallback: Direkte API-Abfrage mit Force-Flag und Color-Parameter
          const apiUrl = `getReservationDetails.php?id=${resId}&includeColor=true&force=${Date.now()}`;
          const response = window.HttpUtils
            ? await HttpUtils.requestJson(apiUrl, {}, { retries: 2, timeout: 8000 })
            : await fetch(apiUrl).then(r => r.json());

          if (response && response.detail) {
            console.log('‚úÖ FORCE Header-Daten erfolgreich geladen:', response.detail);
            updateHeaderDirectly(response.detail);
          } else {
            console.warn('‚ö†Ô∏è Keine g√ºltigen Daten von getReservationDetails.php erhalten');
          }
        }
      } catch (error) {
        console.error('‚ùå Fehler beim FORCE Header-Update:', error);
      }
    }

    // Header-Daten neu laden mit Debouncing
    function refreshHeaderData() {
      // Verhindere mehrfache gleichzeitige Aufrufe
      if (isHeaderRefreshing) {
        console.log('üîÑ Header-Refresh bereits aktiv, √ºberspringe...');
        return;
      }

      // Vorherige Timeouts l√∂schen
      if (headerRefreshTimeout) {
        clearTimeout(headerRefreshTimeout);
      }

      // Debounced Refresh nach 100ms
      headerRefreshTimeout = setTimeout(() => {
        performHeaderRefresh();
      }, 100);
    }

    async function performHeaderRefresh() {
      if (isHeaderRefreshing) {
        return;
      }

      // Zus√§tzliche Pr√ºfung auf reservation.js Aktivit√§t
      if (window.reservationJsLoading) {
        console.log('üö´ reservation.js ist bereits am Laden, HTML √ºberspringt');
        return;
      }

      isHeaderRefreshing = true;

      try {
        // Reservierungs-ID aus URL holen
        const urlParams = new URLSearchParams(window.location.search);
        const resId = urlParams.get('id');

        if (!resId) {
          console.warn('‚ö†Ô∏è Keine Reservierungs-ID in URL gefunden');
          return;
        }

        console.log('üîÑ Lade Header-Daten f√ºr Reservierung ID:', resId);

        // Pr√ºfe ob reservation.js bereits geladen wurde und die Daten l√§dt
        if (window.headerDataLoadInitiated && typeof window.loadReservationData === 'function') {
          // Pr√ºfe sofort ob reservation.js bereits aktiv ist
          if (window.reservationJsLoading || window.currentReservationData) {
            console.log('‚úÖ reservation.js bereits aktiv, HTML √ºberspringt komplett');
            return;
          }

          // Warte kurz ab ob reservation.js bereits am Laden ist
          let reservationJsTimeout = setTimeout(() => {
            console.log('‚è≥ reservation.js scheint nicht zu laden, verwende eigene Logik...');
            performActualRefresh(resId);
          }, 150); // Erh√∂ht von 300ms auf 150ms f√ºr bessere Reaktion

          // Pr√ºfe alle 25ms ob reservation.js bereits aktiv ist (h√§ufiger)
          let checkInterval = setInterval(() => {
            if (window.reservationJsLoading || window.currentReservationData || document.querySelector('.header-info').textContent.trim()) {
              console.log('‚úÖ reservation.js hat bereits Daten geladen, √ºberspringe eigenen Aufruf');
              clearTimeout(reservationJsTimeout);
              clearInterval(checkInterval);
            }
          }, 25);

          // Cleanup nach 1 Sekunde (reduziert von 2 Sekunden)
          setTimeout(() => {
            clearTimeout(reservationJsTimeout);
            clearInterval(checkInterval);
          }, 1000);

        } else {
          // reservation.js nicht verf√ºgbar, verwende direkte Logik
          performActualRefresh(resId);
        }

      } finally {
        // Nach 1 Sekunde wieder freigeben
        setTimeout(() => {
          isHeaderRefreshing = false;
        }, 1000);
      }
    }

    async function performActualRefresh(resId) {
      // Progressive Retry-Logik f√ºr reservation.js Funktionen
      let retryCount = 0;
      const maxRetries = 5;
      const retryDelay = 200;

      const tryLoadReservationData = () => {
        if (typeof window.loadReservationData === 'function') {
          console.log('‚úÖ Verwende loadReservationData() aus reservation.js');
          window.loadReservationData().then(() => {
            console.log('‚úÖ Header-Update √ºber loadReservationData abgeschlossen');
          }).catch(error => {
            console.error('‚ùå Fehler beim Header-Update:', error);
          });
        } else if (retryCount < maxRetries) {
          retryCount++;
          console.log(`‚è≥ loadReservationData noch nicht verf√ºgbar (Versuch ${retryCount}/${maxRetries}), wiederhole in ${retryDelay}ms...`);
          setTimeout(tryLoadReservationData, retryDelay);
        } else {
          console.warn('‚ö†Ô∏è loadReservationData nach mehreren Versuchen nicht verf√ºgbar, verwende Fallback');
          loadHeaderDataDirectly(resId);
        }
      };

      tryLoadReservationData();
    }

    // Direkte Header-Daten-Abfrage √ºber reservation.js loadReservationData
    async function loadHeaderDataDirectly(resId) {
      try {
        console.log('üì° Lade Header-Daten √ºber reservation.js loadReservationData...');

        // reservation.js loadReservationData Funktion aufrufen wenn verf√ºgbar
        if (typeof loadReservationData === 'function') {
          console.log('‚úÖ Verwende loadReservationData() aus reservation.js');
          await loadReservationData();
          console.log('‚úÖ Header-Update √ºber loadReservationData abgeschlossen');
        } else {
          console.log('‚ö†Ô∏è loadReservationData nicht gefunden, verwende Fallback');

          // Fallback: Direkte API-Abfrage mit Color-Parameter
          const apiUrl = `getReservationDetails.php?id=${resId}&includeColor=true`;
          const response = window.HttpUtils
            ? await HttpUtils.requestJson(apiUrl, {}, { retries: 2, timeout: 8000 })
            : await fetch(apiUrl).then(r => r.json());

          if (response) {
            console.log('‚úÖ Header-Daten erfolgreich geladen (Fallback):', response);
            updateHeaderDirectly(response);
          } else {
            console.warn('‚ö†Ô∏è Keine Daten von getReservationDetails.php erhalten');
          }
        }
      } catch (error) {
        console.error('‚ùå Fehler beim Laden der Header-Daten:', error);
      }
    }

    // Direkter DOM-Update falls keine passende Funktion gefunden wird
    function updateHeaderDirectly(data) {
      console.log('üîß F√ºhre direkten DOM-Update durch...', data);

      const headerElement = document.getElementById('resHeader');
      if (!headerElement) {
        console.warn('‚ö†Ô∏è Header-Element nicht gefunden');
        return;
      }

      // Use server-provided color if available
      if (data.headerColor) {
        console.log('‚úÖ Verwende Server-berechnete Farbe:', data.headerColor, data.headerColorName);

        // Multiple approaches to ensure color update works
        // 1. CSS Variable (primary method)
        document.documentElement.style.setProperty('--res-header-bg', data.headerColor, 'important');

        // 2. Direct style on element (fallback)
        headerElement.style.setProperty('background-color', data.headerColor, 'important');

        // 3. Force re-render by toggling class
        headerElement.classList.remove('invoice-header', 'normal-header');
        setTimeout(() => {
          headerElement.classList.add(data.isInvoice ? 'invoice-header' : 'normal-header');
        }, 10);

        console.log('üé® FORCE Header-Farbe gesetzt (Server):', {
          invoice: data.invoice,
          isInvoice: data.isInvoice,
          color: data.headerColor,
          colorName: data.headerColorName
        });

      } else if (data.invoice !== undefined) {
        // Fallback: Client-side calculation
        console.log('‚öôÔ∏è Verwende Client-seitige Farb-Berechnung');

        // Explizite Behandlung aller m√∂glichen Invoice-Werte
        const isInvoice = data.invoice === true || data.invoice === 1 || data.invoice === '1' || data.invoice === 'true';
        const color = isInvoice ? '#B8860B' : '#2d8f4f'; // Dark Gold : Dark Green

        // Multiple approaches to ensure color update works
        // 1. CSS Variable
        document.documentElement.style.setProperty('--res-header-bg', color, 'important');

        // 2. Direct style on element
        headerElement.style.setProperty('background-color', color, 'important');

        // 3. Force re-render by toggling class
        headerElement.classList.remove('invoice-header', 'normal-header');
        setTimeout(() => {
          headerElement.classList.add(isInvoice ? 'invoice-header' : 'normal-header');
        }, 10);

        console.log('üé® FORCE Header-Farbe gesetzt (Client):', {
          invoice: data.invoice,
          isInvoice: isInvoice,
          color: color,
          result: isInvoice ? 'DARK GOLD' : 'DARK GREEN'
        });

      } else {
        console.warn('‚ö†Ô∏è Keine invoice-Daten in Response gefunden:', data);
      }

      // Header-Text aktualisieren falls vorhanden
      const headerInfo = document.querySelector('.header-info');
      if (headerInfo && data) {
        console.log('üìù Header-Info-Element gefunden - bereit f√ºr Updates');
      }
    }
  </script>
</body>

</html>