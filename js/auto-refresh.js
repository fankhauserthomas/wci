// Automatisches Refresh-System (Hintergrund)
let autoRefreshInterval = null;
let autoRefreshEnabled = false;

function startAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
  }

  autoRefreshEnabled = true;
  console.log('üîÑ Auto-Refresh gestartet (l√§uft im Hintergrund alle 10 Sekunden)');

  autoRefreshInterval = setInterval(async () => {
    if (!autoRefreshEnabled) {
      // Tab ist inaktiv - markiere dass Sortierung n√∂tig ist
      pendingSortUpdate = true;
      console.log('üîÑ Auto-Refresh: Tab inaktiv - Sortierung wird bei Aktivierung nachgeholt');
      return;
    }

    try {
      console.log('üîÑ Auto-Refresh: Aktualisiere Daten...');

      // Cache invalidieren und neu laden
      if (window.realHpData) {
        window.realHpData.clear();
      }
      if (window.lastHpDataKey) {
        window.lastHpDataKey = null;
      }

      // Pr√ºfe ob loadRealHpData verf√ºgbar ist
      if (typeof window.loadRealHpData === 'function') {
        const success = await window.loadRealHpData();

        if (success) {
          // Kurze Pause f√ºr DOM-Updates
          await new Promise(resolve => setTimeout(resolve, 100));

          // Farbschema aktualisieren (zuerst)
          if (typeof window.updateColorScheme === 'function') {
            // Bestimme aktuellen Modus
            const mode = localStorage.getItem('filterMode') || 'arrival';
            const isArrival = mode.startsWith('arrival');
            window.updateColorScheme(isArrival);
            console.log('‚úÖ Auto-Refresh: Farbschema aktualisiert');
          }

          // Weitere Pause vor Sortierung
          await new Promise(resolve => setTimeout(resolve, 200));

          // NUR Sortierung anwenden OHNE erneuten Datenload
          const tbody = document.querySelector('#resTable tbody');
          if (tbody && window.realHpData) {
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
              if (typeof window.setSortGroupForRow === 'function') {
                window.setSortGroupForRow(row);
              }
            });
            console.log('‚úÖ Auto-Refresh: Sortgruppen direkt angewendet (ohne erneuten Datenload)');

            // Stelle sicher, dass pending flag zur√ºckgesetzt wird
            pendingSortUpdate = false;
          }

          console.log('‚úÖ Auto-Refresh: Vollst√§ndig aktualisiert (Daten + Formatierung + Sortierung)');
        }
      } else if (typeof window.loadData === 'function') {
        // Fallback auf loadData wenn loadRealHpData nicht verf√ºgbar
        await window.loadData();

        // Auch hier Formatierung anwenden
        if (typeof window.setAllSortGroups === 'function') {
          await window.setAllSortGroups();
          console.log('‚úÖ Auto-Refresh: Sortgruppen √ºber loadData angewendet');
        }

        // Farbschema auch im Fallback
        if (typeof window.updateColorScheme === 'function') {
          const mode = localStorage.getItem('filterMode') || 'arrival';
          const isArrival = mode.startsWith('arrival');
          window.updateColorScheme(isArrival);
          console.log('‚úÖ Auto-Refresh: Farbschema √ºber loadData aktualisiert');
        }

        console.log('‚úÖ Auto-Refresh: Daten √ºber loadData aktualisiert + formatiert');
      } else {
        console.warn('‚ö†Ô∏è Auto-Refresh: Keine Ladefunktionen verf√ºgbar');
      }

    } catch (error) {
      console.error('‚ùå Auto-Refresh Fehler:', error);
    }
  }, 10000); // 10 Sekunden
}

function stopAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = null;
  }
  autoRefreshEnabled = false;
  console.log('‚èπÔ∏è Auto-Refresh gestoppt');
}

// Global verf√ºgbar machen
window.startAutoRefresh = startAutoRefresh;
window.stopAutoRefresh = stopAutoRefresh;

// Debug- und Test-Funktionen
window.testImmediateSorting = () => applyImmediateSorting('manual-test');
window.forceSortingNow = () => {
  console.log('üîß Erzwinge Sortierung JETZT...');
  pendingSortUpdate = true;
  return applyImmediateSorting('force-manual');
};

window.debugAutoRefresh = function () {
  console.log('=== AUTO-REFRESH DEBUG ===');
  console.log('autoRefreshEnabled:', autoRefreshEnabled);
  console.log('pendingSortUpdate:', pendingSortUpdate);
  console.log('isTabActive:', isTabActive);
  console.log('autoRefreshInterval:', autoRefreshInterval ? 'l√§uft' : 'gestoppt');
  console.log('realHpData verf√ºgbar:', !!window.realHpData);
  console.log('realHpData Gr√∂√üe:', window.realHpData ? window.realHpData.size : 'N/A');
  console.log('loadRealHpData verf√ºgbar:', typeof window.loadRealHpData === 'function');
  console.log('setSortGroupForRow verf√ºgbar:', typeof window.setSortGroupForRow === 'function');
  console.log('updateColorScheme verf√ºgbar:', typeof window.updateColorScheme === 'function');

  const tbody = document.querySelector('#resTable tbody');
  console.log('Tabellen-Body:', tbody ? `${tbody.children.length} Zeilen` : 'nicht gefunden');

  // Teste sofortige Sortierung
  console.log('--- TESTE SOFORTIGE SORTIERUNG ---');
  window.forceSortingNow();
};

// Auto-Refresh starten nach Seitenladen
window.addEventListener('load', () => {
  // Sofort Event-Listener installieren
  setupRobustEventListeners();

  setTimeout(() => {
    // Warte bis alle Funktionen geladen sind
    if (typeof window.loadRealHpData === 'function' || typeof window.loadData === 'function') {
      startAutoRefresh();

      // Initiale Sortierung nach 1 Sekunde
      setTimeout(() => {
        console.log('üîÑ Initiale Sortierung beim Laden');
        applyImmediateSorting('initial-load');
      }, 1000);

    } else {
      console.warn('‚ö†Ô∏è Auto-Refresh: Warte auf Verf√ºgbarkeit der Ladefunktionen...');
      // Versuche nochmal nach weiteren 2 Sekunden
      setTimeout(() => {
        if (typeof window.loadRealHpData === 'function' || typeof window.loadData === 'function') {
          startAutoRefresh();
          setTimeout(() => applyImmediateSorting('delayed-load'), 500);
        }
      }, 2000);
    }
  }, 3000); // Reduziert von 5000ms auf 3000ms
});

// Robuste Event-Erkennung f√ºr alle Plattformen
let pendingSortUpdate = false;
let lastVisibilityChange = 0;
let isTabActive = !document.hidden;

// Funktion f√ºr sofortige Sortierung (vereinfacht und robuster)
async function applyImmediateSorting(source = 'unbekannt') {
  console.log(`üîÑ Sofortige Sortierung ausgel√∂st von: ${source}`);

  // Stelle sicher, dass wir Daten haben
  if (!window.realHpData || window.realHpData.size === 0) {
    console.warn('‚ö†Ô∏è Keine Daten verf√ºgbar - lade Daten nach');
    if (typeof window.loadRealHpData === 'function') {
      const success = await window.loadRealHpData();
      if (!success) {
        console.error('‚ùå Datenload fehlgeschlagen');
        return false;
      }
    } else {
      console.error('‚ùå loadRealHpData Funktion nicht verf√ºgbar');
      return false;
    }
  }

  console.log(`üìä Verwende ${window.realHpData.size} Daten-Eintr√§ge`);

  // 1. Farbschema SOFORT anwenden
  if (typeof window.updateColorScheme === 'function') {
    const mode = localStorage.getItem('filterMode') || 'arrival';
    const isArrival = mode.startsWith('arrival');
    window.updateColorScheme(isArrival);
    console.log('‚úÖ Farbschema sofort angewendet');
  }

  // 2. Sortierung SOFORT anwenden
  const tbody = document.querySelector('#resTable tbody');
  if (!tbody) {
    console.warn('‚ö†Ô∏è Tabellen-Body nicht gefunden');
    return false;
  }

  const rows = tbody.querySelectorAll('tr');
  let appliedCount = 0;

  rows.forEach((row, index) => {
    if (typeof window.setSortGroupForRow === 'function') {
      const resId = parseInt(row.dataset.resId);
      if (window.realHpData.has(resId)) {
        const realData = window.realHpData.get(resId);
        window.setSortGroupForRow(row);
        appliedCount++;

        // Debug f√ºr erste 3 Zeilen
        if (index < 3) {
          const nameCell = row.querySelector('.name-cell');
          const classes = nameCell ? Array.from(nameCell.classList).join(', ') : 'keine name-cell';
          console.log(`üîç Zeile ${index}: ResID ${resId}, Gruppe "${realData.sortGroup}", Klassen: [${classes}]`);
        }
      }
    }
  });

  // 3. FORCED REPAINT (aggressiv f√ºr alle Browser)
  tbody.style.visibility = 'hidden';
  tbody.offsetHeight; // Force reflow
  tbody.style.visibility = 'visible';

  // Zus√§tzlicher Repaint-Trick
  document.body.classList.add('force-repaint');
  requestAnimationFrame(() => {
    document.body.classList.remove('force-repaint');
  });

  console.log(`‚úÖ Sortierung abgeschlossen: ${appliedCount}/${rows.length} Zeilen verarbeitet + Repaint erzwungen`);
  pendingSortUpdate = false;
  return true;
}

// Einfaches aber robustes Event-System
function setupRobustEventListeners() {
  // Track Tab-Status
  document.addEventListener('visibilitychange', () => {
    const wasActive = isTabActive;
    isTabActive = !document.hidden;
    lastVisibilityChange = Date.now();

    if (!wasActive && isTabActive) {
      // Tab wurde gerade aktiviert
      console.log('üîÑ Tab aktiviert - f√ºhre Sortierung aus');
      setTimeout(() => applyImmediateSorting('visibilitychange'), 100);
    }

    if (isTabActive) {
      autoRefreshEnabled = true;
      if (!autoRefreshInterval) {
        setTimeout(startAutoRefresh, 2000);
      }
    } else {
      autoRefreshEnabled = false;
      pendingSortUpdate = true;
    }
  });

  // Window Focus (f√ºr Desktop)
  window.addEventListener('focus', () => {
    console.log('üîÑ Window Focus - f√ºhre Sortierung aus');
    setTimeout(() => applyImmediateSorting('focus'), 100);
  });

  // Page Show (f√ºr Mobile und Back-Navigation)
  window.addEventListener('pageshow', (event) => {
    console.log('üîÑ Page Show - f√ºhre Sortierung aus');
    setTimeout(() => applyImmediateSorting('pageshow'), 150);
  });

  // Backup: Polling System (alle 2 Sekunden pr√ºfen ob Sortierung n√∂tig)
  setInterval(() => {
    if (isTabActive && pendingSortUpdate && Date.now() - lastVisibilityChange > 1000) {
      console.log('üîÑ Backup-Polling aktiviert - f√ºhre Sortierung aus');
      applyImmediateSorting('polling-backup');
    }
  }, 2000);

  console.log('‚úÖ Robuste Event-Listener installiert');
}
