<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistiken - WebCheckin</title>
  <link rel="stylesheet" href="include/style.css">
  <style>
    .stats-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .stats-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .stats-title {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .stats-subtitle {
      font-size: 1.2rem;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    .back-button {
      background: var(--secondary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 30px;
    }

    .back-button:hover {
      background: #0056b3;
      text-decoration: none;
      color: white;
    }

    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 30px 25px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .stat-label {
      font-size: 1rem;
      opacity: 0.95;
      font-weight: 500;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .detailed-stats {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border);
      margin-bottom: 30px;
    }

    .detailed-stats h3 {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
    }

    .date-selector {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border);
      margin-bottom: 30px;
      text-align: center;
    }

    .date-input {
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin: 0 10px;
      font-size: 1rem;
    }

    .refresh-button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      margin-left: 10px;
    }

    .refresh-button:hover {
      background: var(--primary-dark);
    }

    /* Unvollständige Reservierungen Styles */
    .incomplete-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      border-radius: 6px;
      overflow-y: auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      max-height: 370px;
      /* 10 rows * 37px */
      display: block;
      font-size: 0.95rem;
    }

    .incomplete-table th,
    .incomplete-table td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #eee;
      height: 37px;
    }

    .incomplete-table th {
      background: var(--primary);
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .incomplete-table tr:hover {
      background: #f8f9fa;
      cursor: pointer;
    }

    .incomplete-table .name-cell {
      font-weight: 600;
      color: var(--primary);
    }

    .incomplete-table .percentage-cell {
      text-align: center;
      font-weight: bold;
    }

    .incomplete-table .percentage-low {
      color: #dc3545;
    }

    .incomplete-table .percentage-medium {
      color: #fd7e14;
    }

    .incomplete-table .guests-cell {
      text-align: center;
      font-weight: 600;
    }

    .incomplete-table .date-cell {
      font-size: 0.9rem;
      color: #666;
    }

    .incomplete-summary {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary);
    }

    .incomplete-summary strong {
      color: var(--primary);
    }

    /* Duplicate Reservations Styles */
    .duplicate-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      border-radius: 6px;
      overflow-y: auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      max-height: 400px;
      display: block;
      font-size: 0.9rem;
    }

    .duplicate-table th,
    .duplicate-table td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    .duplicate-table th {
      background: var(--primary);
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .duplicate-table tr:hover {
      background: #f8f9fa;
    }

    .duplicate-pair {
      border-left: 4px solid #dc3545;
      background: #fff5f5;
    }

    .duplicate-pair.high-confidence {
      border-left-color: #dc3545;
      background: #fff5f5;
    }

    .duplicate-pair.medium-confidence {
      border-left-color: #fd7e14;
      background: #fff8f0;
    }

    .duplicate-pair.low-confidence {
      border-left-color: #ffc107;
      background: #fffbf0;
    }

    .confidence-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
      color: white;
    }

    .confidence-high {
      background: #dc3545;
    }

    .confidence-medium {
      background: #fd7e14;
    }

    .confidence-low {
      background: #ffc107;
      color: #333;
    }

    .similarity-details {
      font-size: 0.8rem;
      color: #666;
      margin-top: 4px;
    }

    .duplicate-summary {
      background: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #ffc107;
    }

    .duplicate-summary strong {
      color: #856404;
    }

    @media (max-width: 768px) {
      .stats-container {
        padding: 15px;
      }

      .stats-title {
        font-size: 2rem;
      }

      .quick-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .stat-card {
        padding: 20px 15px;
      }

      .stat-number {
        font-size: 2rem;
      }
    }
  </style>
</head>

<body>
  <!-- Navigation wird durch JavaScript eingefügt -->

  <main class="stats-container main-content">
    <!-- Entferne Zurück-Button da in Navigation -->

    <!-- Connection Status -->
    <div class="connection-status" id="connection-indicator">
      <div class="status-dot"></div>
      <span class="status-text">Verbindung prüfen...</span>
    </div>

    <div class="stats-header">
      <h1 class="stats-title">Statistiken</h1>
      <p class="stats-subtitle">Reservierungen und Auslastung</p>
    </div>

    <!-- Date Selector -->
    <div class="date-selector">
      <label for="statsDate">Datum auswählen:</label>
      <input type="date" id="statsDate" class="date-input" value="">
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="stat-card">
        <div class="stat-number" id="todayArrivals">-</div>
        <div class="stat-label">Anreisen heute</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="todayDepartures">-</div>
        <div class="stat-label">Abreisen heute</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalGuests">-</div>
        <div class="stat-label">Gäste aktuell</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalDogs">-</div>
        <div class="stat-label">Hunde aktuell</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pendingCheckins">-</div>
        <div class="stat-label">Offene Check-ins</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pendingCheckouts">-</div>
        <div class="stat-label">Offene Check-outs</div>
      </div>
    </div>

    <!-- Unvollständige Reservierungen -->
    <div class="detailed-stats" style="margin-bottom: 30px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Unvollständige Reservierungen</h3>
        <button class="refresh-button" onclick="toggleIncompleteSettings()">⚙️ Einstellungen</button>
      </div>

      <!-- Einstellungen Panel -->
      <div id="incomplete-settings"
        style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div>
            <label for="min-guests-setting">Mindest-Gästeanzahl:</label>
            <input type="number" id="min-guests-setting" min="1" max="20" value="4"
              style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label for="max-percentage-setting">Max. Namen-Vollständigkeit (%):</label>
            <input type="number" id="max-percentage-setting" min="0" max="100" value="75"
              style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label for="days-setting">Tage voraus:</label>
            <input type="number" id="days-setting" min="1" max="365" value="14"
              style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
        </div>
        <div style="margin-top: 15px; text-align: center;">
          <button class="refresh-button" onclick="loadIncompleteReservations()">Aktualisieren</button>
          <button class="refresh-button" onclick="saveIncompleteSettings()"
            style="background: #28a745;">Speichern</button>
        </div>
      </div>

      <div id="incomplete-reservations">
        <p>Lade unvollständige Reservierungen...</p>
      </div>
    </div>

    <!-- Doppelreservierungen -->
    <div class="detailed-stats" style="margin-bottom: 30px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Potentielle Doppelreservierungen</h3>
        <button class="refresh-button" onclick="toggleDuplicateSettings()">⚙️ Einstellungen</button>
      </div>

      <!-- Einstellungen Panel -->
      <div id="duplicate-settings"
        style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div>
            <label for="duplicate-days-setting">Tage voraus:</label>
            <input type="number" id="duplicate-days-setting" min="1" max="365" value="90"
              style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label for="similarity-threshold-setting">Ähnlichkeits-Schwelle (%):</label>
            <input type="number" id="similarity-threshold-setting" min="50" max="100" value="75"
              style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
        </div>
        <div style="margin-top: 15px; text-align: center;">
          <button class="refresh-button" onclick="loadDuplicateReservations()">Aktualisieren</button>
          <button class="refresh-button" onclick="saveDuplicateSettings()"
            style="background: #28a745;">Speichern</button>
        </div>
      </div>

      <div id="duplicate-reservations">
        <p>Lade Doppelreservierungen...</p>
      </div>
    </div>

    <!-- Detailed Statistics -->
    <div class="stats-grid">
      <!-- Wochenübersicht statt tägliche Listen -->
      <div class="detailed-stats" style="grid-column: 1 / -1;">
        <h3>Wochenübersicht - An- und Abreisen</h3>
        <div id="weekly-overview">
          <p>Lade Wochendaten...</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Scripts -->
  <script src="include/js/http-utils.js"></script>
  <script src="include/js/loading-overlay.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Set today's date
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById('statsDate').value = today;

      // Add automatic update on date change
      document.getElementById('statsDate').addEventListener('change', loadStatsForDate);

      // Load initial stats
      await loadStatsForDate();

      // Load initial incomplete reservations
      loadIncompleteSettings();
      await loadIncompleteReservations();

      // Load initial duplicate reservations
      loadDuplicateSettings();
      await loadDuplicateReservations();

      // Set up connection monitoring
      setupConnectionMonitoring();
    });

    async function loadStatsForDate() {
      const selectedDate = document.getElementById('statsDate').value || new Date().toISOString().slice(0, 10);

      try {
        // Load basic stats
        await loadQuickStats(selectedDate);

        // Load detailed data
        await loadDetailedStats(selectedDate);

      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    async function loadQuickStats(date) {
      try {
        // Use new dedicated stats API
        const statsPromise = window.HttpUtils
          ? HttpUtils.requestJsonWithLoading(`stats-api.php?date=${date}`, {}, {}, 'Statistiken werden geladen...')
          : LoadingOverlay.wrapFetch(() => fetch(`stats-api.php?date=${date}`).then(r => r.json()), 'Statistiken');

        const stats = await statsPromise;

        // Update display with correct values
        document.getElementById('todayArrivals').textContent = stats.arrivals_today || 0;
        document.getElementById('todayDepartures').textContent = stats.departures_tomorrow || 0;
        document.getElementById('totalGuests').textContent = stats.guests_in_house || 0;
        document.getElementById('totalDogs').textContent = stats.dogs_in_house || 0;
        document.getElementById('pendingCheckins').textContent =
          `${stats.checkins.pending_checkins}/${stats.checkins.total_reservations}`;
        document.getElementById('pendingCheckouts').textContent =
          `${stats.checkouts.pending_checkouts}/${stats.checkouts.total_reservations}`;

      } catch (error) {
        console.error('Error loading quick stats:', error);
        // Set fallback values
        document.getElementById('todayArrivals').textContent = '?';
        document.getElementById('todayDepartures').textContent = '?';
        document.getElementById('totalGuests').textContent = '?';
        document.getElementById('totalDogs').textContent = '?';
        document.getElementById('pendingCheckins').textContent = '?';
        document.getElementById('pendingCheckouts').textContent = '?';
      }
    }

    async function loadDetailedStats(date) {
      try {
        // Load only weekly overview, no daily lists
        await loadWeeklyOverview(date);

      } catch (error) {
        console.error('Error loading detailed stats:', error);
        document.getElementById('weekly-overview').innerHTML = '<p>Fehler beim Laden der Wochendaten.</p>';
      }
    }

    async function loadWeeklyOverview(date) {
      try {
        // Use new weekly stats API
        const weeklyResponse = window.HttpUtils
          ? HttpUtils.requestJsonWithLoading(`weekly-stats-api.php?start_date=${date}`, {}, {}, 'Wochendaten werden geladen...')
          : LoadingOverlay.wrapFetch(() => fetch(`weekly-stats-api.php?start_date=${date}`).then(r => r.json()), 'Wochendaten');

        const weeklyData = await weeklyResponse;

        const weeklyHtml = `
          <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 15px; text-align: center;">
            ${weeklyData.map(day => `
              <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: ${day.date === date ? '#e7f3ff' : 'white'};">
                <strong>${day.day_name}</strong><br>
                <small>${day.formatted_date}</small><br>
                
                <div style="margin-top: 10px;">
                  <div style="color: #2c3e50; font-weight: bold; font-size: 1.2em; margin-bottom: 8px;">${day.guests_in_house}</div>
                  
                  <div style="color: green; font-weight: bold; font-size: 1.1em;">↗ ${day.guests_arriving}/${day.reservations_arriving}</div>
                  
                  <div style="color: red; font-weight: bold; font-size: 1.1em;">↙ ${day.guests_departing}/${day.reservations_departing}</div>
                  
                  ${day.dogs_in_house > 0 ? `
                    <div style="margin-top: 8px;"><img src="pic/dog.svg" style="width: 16px; height: 16px; vertical-align: middle;"> ${day.dogs_in_house}</div>
                  ` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        `;

        document.getElementById('weekly-overview').innerHTML = weeklyHtml;

      } catch (error) {
        console.error('Error loading weekly overview:', error);
        document.getElementById('weekly-overview').innerHTML = '<p>Fehler beim Laden der Wochendaten.</p>';
      }
    }

    function setupConnectionMonitoring() {
      // Connection status update function (same as dashboard)
      function updateConnectionStatus() {
        const monitor = window.connectionMonitor;
        if (!monitor) return;

        const indicator = document.getElementById('connection-indicator');
        const navStatus = document.getElementById('nav-connection-status');

        if (!indicator || !navStatus) return;

        const dot = indicator.querySelector('.status-dot');
        const text = indicator.querySelector('.status-text');
        const navDot = navStatus.querySelector('.status-dot');
        const navText = navStatus.querySelector('.status-text');

        const quality = monitor.getQuality();
        const isOnline = monitor.isOnline();

        if (!isOnline) {
          dot.style.backgroundColor = '#dc3545';
          text.textContent = 'Offline';
          navDot.style.backgroundColor = '#dc3545';
          navText.textContent = 'Offline';
        } else {
          switch (quality) {
            case 'excellent':
            case 'good':
              dot.style.backgroundColor = '#28a745';
              text.textContent = 'Online';
              navDot.style.backgroundColor = '#28a745';
              navText.textContent = 'Online';
              break;
            case 'fair':
              dot.style.backgroundColor = '#ffc107';
              text.textContent = 'Langsam';
              navDot.style.backgroundColor = '#ffc107';
              navText.textContent = 'Langsam';
              break;
            case 'poor':
              dot.style.backgroundColor = '#fd7e14';
              text.textContent = 'Sehr langsam';
              navDot.style.backgroundColor = '#fd7e14';
              navText.textContent = 'Sehr langsam';
              break;
            default:
              dot.style.backgroundColor = '#6c757d';
              text.textContent = 'Unbekannt';
              navDot.style.backgroundColor = '#6c757d';
              navText.textContent = 'Unbekannt';
          }
        }
      }

      // Update every 5 seconds
      setInterval(updateConnectionStatus, 5000);
      setTimeout(updateConnectionStatus, 2000);

      // Click handlers
      document.getElementById('connection-indicator')?.addEventListener('click', () => {
        if (window.connectionMonitor && window.HttpUtils) {
          HttpUtils.showDetailedConnectionStatus(window.connectionMonitor);
        }
      });

      document.getElementById('nav-connection-status')?.addEventListener('click', () => {
        if (window.connectionMonitor && window.HttpUtils) {
          HttpUtils.showDetailedConnectionStatus(window.connectionMonitor);
        }
      });
    }

    // Unvollständige Reservierungen Funktionen
    function loadIncompleteSettings() {
      // Lade Einstellungen aus Cookies
      const minGuests = getCookie('incomplete_min_guests') || '4';
      const maxPercentage = getCookie('incomplete_max_percentage') || '75';
      const days = getCookie('incomplete_days') || '14';

      document.getElementById('min-guests-setting').value = minGuests;
      document.getElementById('max-percentage-setting').value = maxPercentage;
      document.getElementById('days-setting').value = days;
    }

    function saveIncompleteSettings() {
      const minGuests = document.getElementById('min-guests-setting').value;
      const maxPercentage = document.getElementById('max-percentage-setting').value;
      const days = document.getElementById('days-setting').value;

      // Speichere in Cookies (1 Jahr gültig)
      const expires = new Date();
      expires.setFullYear(expires.getFullYear() + 1);

      setCookie('incomplete_min_guests', minGuests, expires);
      setCookie('incomplete_max_percentage', maxPercentage, expires);
      setCookie('incomplete_days', days, expires);

      // Lade Daten neu
      loadIncompleteReservations();

      // Erfolgsmeldung
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '✓ Gespeichert';
      btn.style.background = '#28a745';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 2000);
    }

    function toggleIncompleteSettings() {
      const panel = document.getElementById('incomplete-settings');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    async function loadIncompleteReservations() {
      const container = document.getElementById('incomplete-reservations');
      container.innerHTML = '<p>Lade unvollständige Reservierungen...</p>';

      try {
        const minGuests = document.getElementById('min-guests-setting').value;
        const maxPercentage = document.getElementById('max-percentage-setting').value;
        const days = document.getElementById('days-setting').value;

        const response = await fetch(`getIncompleteReservations.php?min_guests=${minGuests}&max_percentage=${maxPercentage}&days=${days}`);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Unbekannter Fehler');
        }

        renderIncompleteReservations(data);

      } catch (error) {
        console.error('Error loading incomplete reservations:', error);
        container.innerHTML = `<p style="color: red;">Fehler beim Laden: ${error.message}</p>`;
      }
    }

    function renderIncompleteReservations(data) {
      const container = document.getElementById('incomplete-reservations');
      const reservations = data.data;
      const params = data.parameters;

      let html = `
        <div class="incomplete-summary">
          <strong>${reservations.length}</strong> unvollständige Reservierungen gefunden<br>
          <small>Filter: Min. ${params.min_guests} Gäste, Max. ${params.max_percentage}% Namen, ${params.days} Tage voraus (${params.date_range})</small>
        </div>
      `;

      if (reservations.length === 0) {
        html += '<p>🎉 Alle Reservierungen sind vollständig!</p>';
        container.innerHTML = html;
        return;
      }

      html += `
        <table class="incomplete-table">
          <thead>
            <tr>
              <th>Von - Bis</th>
              <th>Name</th>
              <th>Gäste</th>
              <th>Namen</th>
              <th>%</th>
            </tr>
          </thead>
          <tbody>
      `;
      reservations.forEach(res => {
        const percentageClass = res.percentage_complete <= 25 ? 'percentage-low' :
          res.percentage_complete <= 50 ? 'percentage-medium' : '';
        // Name: trim(nonull(nachname) + ' ' + nonull(vorname))
        const nonull = v => (v == null || v === 'null' || v === undefined) ? '' : v;
        const name = (nonull(res.nachname) + ' ' + nonull(res.vorname)).trim();
        html += `
          <tr onclick="openReservation(${res.id})">
            <td class="date-cell">
              ${formatDateShort(res.anreise)} - ${formatDateShort(res.abreise)}
            </td>
            <td class="name-cell">${name}</td>
            <td class="guests-cell">${res.total_guests}</td>
            <td class="guests-cell">${res.entered_names}</td>
            <td class="percentage-cell ${percentageClass}">
              ${res.percentage_complete}%
            </td>
          </tr>
        `;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function openReservation(reservationId) {
      window.open(`reservierungen/reservation.html?id=${reservationId}`, '_blank');
    }

    function formatDateShort(dateStr) {
      if (!dateStr) return '';
      // Handle both formats: "2025-08-01" and "2025-08-01 00:00:00"
      const dateOnly = dateStr.split(' ')[0]; // Get just the date part
      const date = new Date(dateOnly + 'T00:00:00');
      // 19.07. (without year for more compact display)
      return date.toLocaleDateString('de-DE', {
        day: '2-digit',
        month: '2-digit'
      }) + '.';
    }

    // Cookie-Hilfsfunktionen
    function setCookie(name, value, expires) {
      document.cookie = `${name}=${value}; expires=${expires.toUTCString()}; path=/`;
    }

    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }

    // Duplicate Reservations Functions
    function loadDuplicateSettings() {
      // Load settings from cookies
      const days = getCookie('duplicate_days') || '90';
      const threshold = getCookie('duplicate_threshold') || '75';

      document.getElementById('duplicate-days-setting').value = days;
      document.getElementById('similarity-threshold-setting').value = threshold;
    }

    function saveDuplicateSettings() {
      const days = document.getElementById('duplicate-days-setting').value;
      const threshold = document.getElementById('similarity-threshold-setting').value;

      // Save to cookies (1 year validity)
      const expires = new Date();
      expires.setFullYear(expires.getFullYear() + 1);

      setCookie('duplicate_days', days, expires);
      setCookie('duplicate_threshold', threshold, expires);

      // Reload data
      loadDuplicateReservations();

      // Success message
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '✓ Gespeichert';
      btn.style.background = '#28a745';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 2000);
    }

    function toggleDuplicateSettings() {
      const panel = document.getElementById('duplicate-settings');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    async function loadDuplicateReservations() {
      const container = document.getElementById('duplicate-reservations');
      container.innerHTML = '<p>Lade potentielle Doppelreservierungen...</p>';

      try {
        const days = document.getElementById('duplicate-days-setting').value;
        const threshold = parseFloat(document.getElementById('similarity-threshold-setting').value) / 100;

        const response = await fetch(`getDuplicateReservations.php?days=${days}&min_similarity=${threshold}`);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Unbekannter Fehler');
        }

        renderDuplicateReservations(data);

      } catch (error) {
        console.error('Error loading duplicate reservations:', error);
        container.innerHTML = `<p style="color: red;">Fehler beim Laden: ${error.message}</p>`;
      }
    }

    function renderDuplicateReservations(data) {
      const container = document.getElementById('duplicate-reservations');
      const duplicates = data.data;
      const params = data.parameters;

      let html = `
        <div class="duplicate-summary">
          <strong>${duplicates.length}</strong> potentielle Doppelreservierungen gefunden<br>
          <small>Filter: ${params.days_ahead} Tage voraus, min. ${Math.round(params.min_similarity * 100)}% Ähnlichkeit (${params.total_reservations} Reservierungen geprüft, ${params.comparisons_made} Vergleiche)</small>
          ${params.limited_results ? '<br><small style="color: #856404;">⚠️ Ergebnisse begrenzt auf ' + duplicates.length + ' Einträge zur Performance-Optimierung</small>' : ''}
        </div>
      `;

      if (duplicates.length === 0) {
        html += '<p>🎉 Keine verdächtigen Doppelreservierungen gefunden!</p>';
        container.innerHTML = html;
        return;
      }

      html += `
        <table class="duplicate-table">
          <thead>
            <tr>
              <th>Konfidenz</th>
              <th>Name 1</th>
              <th>Zeitraum 1</th>
              <th>E-Mail 1</th>
              <th>Gäste 1</th>
              <th>Name 2</th>
              <th>Zeitraum 2</th>
              <th>E-Mail 2</th>
              <th>Gäste 2</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
      `;

      duplicates.forEach(dup => {
        const confidence = dup.confidence;
        const confidenceClass = confidence >= 90 ? 'high' : confidence >= 75 ? 'medium' : 'low';
        const badgeClass = confidence >= 90 ? 'confidence-high' : confidence >= 75 ? 'confidence-medium' : 'confidence-low';

        const res1 = dup.res1;
        const res2 = dup.res2;

        // Format names
        const name1 = [res1.nachname, res1.vorname].filter(n => n).join(', ');
        const name2 = [res2.nachname, res2.vorname].filter(n => n).join(', ');

        // Format dates
        const period1 = `${formatDateShort(res1.anreise)} - ${formatDateShort(res1.abreise)}`;
        const period2 = `${formatDateShort(res2.anreise)} - ${formatDateShort(res2.abreise)}`;

        // Similarity details
        const details = dup.similarity.details;
        let detailsHtml = '<div class="similarity-details">';
        if (details.name) detailsHtml += `Name: ${Math.round(details.name * 100)}% `;
        if (details.email) detailsHtml += `E-Mail: ${Math.round(details.email * 100)}% `;
        if (details.dates) detailsHtml += `Datum: ${Math.round(details.dates * 100)}% `;
        if (details.guests) detailsHtml += `Gäste: ${Math.round(details.guests * 100)}%`;
        detailsHtml += '</div>';

        html += `
          <tr class="duplicate-pair ${confidenceClass}-confidence" onclick="compareDuplicates(${res1.id}, ${res2.id})">
            <td>
              <span class="confidence-badge ${badgeClass}">${confidence}%</span>
            </td>
            <td><strong>${name1 || '(kein Name)'}</strong></td>
            <td>${period1}</td>
            <td>${res1.email || '(keine E-Mail)'}</td>
            <td>${res1.anzahl_personen}</td>
            <td><strong>${name2 || '(kein Name)'}</strong></td>
            <td>${period2}</td>
            <td>${res2.email || '(keine E-Mail)'}</td>
            <td>${res2.anzahl_personen}</td>
            <td>${detailsHtml}</td>
          </tr>
        `;
      });

      html += '</tbody></table>';

      // Add legend
      html += `
        <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
          <strong>Legende:</strong>
          <span class="confidence-badge confidence-high">90%+</span> Sehr verdächtig
          <span class="confidence-badge confidence-medium">75-89%</span> Verdächtig
          <span class="confidence-badge confidence-low">60-74%</span> Möglich
          <br><small>Klicken Sie auf eine Zeile, um die Reservierungen zu vergleichen.</small>
        </div>
      `;

      container.innerHTML = html;
    }

    function compareDuplicates(id1, id2) {
      // Open both reservations in new tabs for comparison
      window.open(`reservierungen/reservation.html?id=${id1}`, '_blank');
      setTimeout(() => {
        window.open(`reservierungen/reservation.html?id=${id2}`, '_blank');
      }, 500);
    }
  </script>

</body>

</html>
