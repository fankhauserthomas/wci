<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservierungsdetails</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="reservation.css">
    <style>
        body.reservation-details {
            background-color: var(--bg);
            color: var(--text);
        }

        .reservation-form {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-header {
            background: var(--primary);
            color: #fff;
            padding: 0.8rem 1rem;
            margin: -1rem -1rem 1rem -1rem;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-title {
            font-size: 1.2rem;
            margin: 0;
        }

        .header-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: var(--secondary);
            color: white;
        }

        .header-btn:hover {
            background-color: #7f8c8d;
        }

        .form-section {
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 1rem;
            font-weight: bold;
            color: var(--text);
            margin-bottom: 0.8rem;
            padding-bottom: 0.3rem;
            border-bottom: 2px solid var(--primary);
        }

        /* Two-column layout for main content */
        .form-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .form-column {
            display: flex;
            flex-direction: column;
        }

        .form-row {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 0.8rem;
            align-items: flex-start;
        }

        .form-group {
            flex: 1;
            min-width: 0;
        }

        .form-group.half {
            flex: 0 0 calc(50% - 0.4rem);
        }

        .form-group.quarter {
            flex: 0 0 calc(25% - 0.6rem);
        }

        .form-group.readonly {
            opacity: 0.7;
        }

        label {
            display: block;
            margin-bottom: 0.2rem;
            font-weight: 500;
            color: var(--text);
            font-size: 0.85rem;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            font-size: 0.85rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 5px rgba(46, 204, 113, 0.3);
        }

        input:read-only,
        select:disabled {
            background-color: var(--light-gray);
            color: var(--secondary);
            cursor: not-allowed;
        }

        /* Toggle Payment Button */
        .toggle-payment-btn {
            width: 100%;
            padding: 0.4rem;
            border: 2px solid #6c757d;
            border-radius: 4px;
            background: #f8f9fa;
            color: #6c757d;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-family: inherit;
        }

        .toggle-payment-btn[data-value="0"] {
            border-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .toggle-payment-btn[data-value="1"] {
            border-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }

        .toggle-payment-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .toggle-payment-btn:active {
            transform: translateY(0);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .sleeping-categories {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.8rem;
        }

        /* Vorname und Nachname 1,8x größer und fett */
        #vorname,
        #nachname {
            font-size: 1.53rem;
            /* 1.8 * 0.85rem = 1.53rem */
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--light-gray);
            grid-column: 1 / -1;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            font-family: inherit;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #27ae60;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .status-indicator {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-active {
            background-color: var(--light-green);
            color: #155724;
        }

        .status-cancelled {
            background-color: var(--light-salmon);
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--secondary);
        }

        .error {
            background-color: var(--light-salmon);
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
        }

        .success {
            background-color: var(--light-green);
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 1024px) {
            .form-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .sleeping-categories {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .reservation-form {
                margin: 0.5rem;
                padding: 0.8rem;
            }

            .form-row {
                flex-direction: column;
                gap: 0.8rem;
            }

            .form-group.half,
            .form-group.quarter {
                flex: 1;
            }

            .sleeping-categories {
                grid-template-columns: 1fr 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* Tablet Landscape specific optimizations */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            body {
                font-size: 14px;
            }

            .reservation-form {
                max-height: 90vh;
                overflow-y: auto;
            }

            .form-section {
                margin-bottom: 0.8rem;
            }

            .section-title {
                font-size: 0.95rem;
                margin-bottom: 0.6rem;
            }
        }
    </style>

    <style>
        /* Save Modal Styles */
        .save-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 20000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .save-modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .save-modal-content h3 {
            margin: 0 0 1rem 0;
            color: var(--text);
            font-size: 1.3rem;
        }

        .save-modal-content p {
            margin: 0 0 2rem 0;
            color: var(--secondary);
            line-height: 1.5;
        }

        .save-modal-buttons {
            display: flex;
            gap: 0.8rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .save-modal-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
        }

        .save-modal-btn.save-btn {
            background: var(--primary);
            color: white;
        }

        .save-modal-btn.save-btn:hover {
            background: #27ae60;
            transform: translateY(-1px);
        }

        .save-modal-btn.discard-btn {
            background: #e74c3c;
            color: white;
        }

        .save-modal-btn.discard-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .save-modal-btn.stay-btn {
            background: var(--secondary);
            color: white;
        }

        .save-modal-btn.stay-btn:hover {
            background: #7f8c8d;
            transform: translateY(-1px);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @media (max-width: 768px) {
            .save-modal-buttons {
                flex-direction: column;
            }

            .save-modal-btn {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>

<body class="reservation-details">
    <!-- Speicher-Modal -->
    <div id="saveModal" class="save-modal" style="display: none;">
        <div class="save-modal-content">
            <h3>Ungespeicherte Änderungen</h3>
            <p>Sie haben Änderungen vorgenommen, die noch nicht gespeichert wurden.</p>
            <div class="save-modal-buttons">
                <button class="save-modal-btn save-btn" onclick="handleModalAction('save')">Speichern</button>
                <button class="save-modal-btn discard-btn" onclick="handleModalAction('discard')">Verwerfen</button>
                <button class="save-modal-btn stay-btn" onclick="handleModalAction('stay')">Bleiben</button>
            </div>
        </div>
    </div>

    <main class="main-content">
        <div class="reservation-form">
            <div class="form-header">
                <h1 class="form-title">Reservierungsdetails</h1>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button type="button" class="btn btn-secondary header-btn"
                        onclick="safeNavigateBack()">Schließen</button>
                    <div id="statusIndicator"></div>
                </div>
            </div>

            <div id="messageArea"></div>

            <div id="loadingIndicator" class="loading">
                Lade Reservierungsdetails...
            </div>

            <form id="reservationForm" style="display: none;">
                <!-- Basic Info Section - Full Width -->
                <div class="form-section">
                    <h2 class="section-title">Grunddaten</h2>
                    <div class="form-row">
                        <div class="form-group quarter">
                            <label for="id">ID</label>
                            <input type="text" id="id" name="id" readonly>
                        </div>
                        <div class="form-group quarter">
                            <label for="av_id">AV ID</label>
                            <input type="text" id="av_id" name="av_id" readonly>
                        </div>
                        <div class="form-group quarter">
                            <label for="storno" class="checkbox-group">
                                <input type="checkbox" id="storno" name="storno">
                                Storniert
                            </label>
                        </div>
                        <div class="form-group quarter">
                            <label for="invoice">Zahlung</label>
                            <button type="button" id="invoiceBtn" class="toggle-payment-btn" data-value="0">
                                <span class="payment-text">zahlt hier</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Two Column Layout -->
                <div class="form-content">
                    <!-- Left Column -->
                    <div class="form-column">
                        <!-- Personal Data Section -->
                        <div class="form-section">
                            <h2 class="section-title">Persönliche Daten</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="nachname">Nachname *</label>
                                    <input type="text" id="nachname" name="nachname" required>
                                </div>
                                <div class="form-group">
                                    <label for="vorname">Vorname</label>
                                    <input type="text" id="vorname" name="vorname">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="handy">Handy</label>
                                    <input type="tel" id="handy" name="handy">
                                </div>
                                <div class="form-group">
                                    <label for="email">E-Mail</label>
                                    <input type="email" id="email" name="email">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="origin">Ausgangspunkt</label>
                                    <select id="origin" name="origin">
                                        <option value="">Bitte wählen...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="hund" class="checkbox-group">
                                        <input type="checkbox" id="hund" name="hund">
                                        Hund
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Sleeping Categories Section -->
                        <div class="form-section">
                            <h2 class="section-title">Schlafkategorien</h2>
                            <div class="sleeping-categories">
                                <div class="form-group">
                                    <label for="lager">Lager</label>
                                    <input type="number" id="lager" name="lager" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="betten">Betten</label>
                                    <input type="number" id="betten" name="betten" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="dz">Doppelzimmer</label>
                                    <input type="number" id="dz" name="dz" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="sonder">Sonder</label>
                                    <input type="number" id="sonder" name="sonder" min="0" value="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="form-column">
                        <!-- Booking Dates Section -->
                        <div class="form-section">
                            <h2 class="section-title">Aufenthaltsdaten</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="anreise">Anreise *</label>
                                    <input type="datetime-local" id="anreise" name="anreise" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="abreise">Abreise *</label>
                                    <input type="datetime-local" id="abreise" name="abreise" required>
                                </div>
                            </div>
                        </div>

                        <!-- Arrangement Section -->
                        <div class="form-section">
                            <h2 class="section-title">Arrangement</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="arr">Arrangement</label>
                                    <select id="arr" name="arr">
                                        <option value="">Bitte wählen...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div class="form-section">
                            <h2 class="section-title">Bemerkungen</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="bem">Bemerkung</label>
                                    <textarea id="bem" name="bem" rows="2"></textarea>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="bem_av">AV Bemerkung</label>
                                    <textarea id="bem_av" name="bem_av" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons entfernt -->
            </form>
        </div>

        <!-- Connection Status -->
        <div class="connection-status" id="connection-indicator">
            <div class="status-dot"></div>
            <span class="status-text">Verbindung prüfen...</span>
        </div>

        <script src="js/http-utils.js"></script>
        <script src="js/loading-overlay.js"></script>
        <script src="ReservationDetails.js"></script>

        <script>
            // Swipe-Gesten für Touch-Geräte mit Speicher-Abfrage
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            let swipeIndicator = null;
            let hasUnsavedChanges = false;
            let pendingNavigation = false;

            // Modal-Funktionen
            function showSaveModal() {
                const modal = document.getElementById('saveModal');
                modal.style.display = 'flex';
                pendingNavigation = true;
            }

            function hideSaveModal() {
                const modal = document.getElementById('saveModal');
                modal.style.display = 'none';
                pendingNavigation = false;
            }

            function handleModalAction(action) {
                hideSaveModal();

                switch (action) {
                    case 'save':
                        console.log('User chose to save before going back...');
                        const form = document.getElementById('reservationForm');
                        if (form) {
                            const submitEvent = new Event('submit', {
                                bubbles: true,
                                cancelable: true
                            });
                            form.dispatchEvent(submitEvent);

                            setTimeout(() => {
                                hasUnsavedChanges = false;
                                performNavigation();
                            }, 1000);
                        } else {
                            performNavigation();
                        }
                        break;

                    case 'discard':
                        console.log('User chose to discard changes and go back...');
                        hasUnsavedChanges = false;
                        performNavigation();
                        break;

                    case 'stay':
                        console.log('User chose to stay on page...');
                        // Nichts tun, Modal ist bereits geschlossen
                        break;
                }
            }

            // Überwache Formular-Änderungen
            function setupChangeTracking() {
                const form = document.getElementById('reservationForm');
                if (form) {
                    const inputs = form.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        // Speichere ursprüngliche Werte
                        input.dataset.originalValue = input.type === 'checkbox' ? input.checked : (input.value || '');

                        input.addEventListener('change', checkForChanges);
                        input.addEventListener('input', checkForChanges);
                    });

                    // Zahlungsbutton gesondert überwachen
                    const invoiceBtn = document.getElementById('invoiceBtn');
                    if (invoiceBtn) {
                        invoiceBtn.dataset.originalValue = invoiceBtn.getAttribute('data-value') || '0';
                        invoiceBtn.addEventListener('click', checkForChanges);
                    }
                }
            }

            function checkForChanges() {
                const form = document.getElementById('reservationForm');
                if (!form) return;

                const inputs = form.querySelectorAll('input, select, textarea');
                hasUnsavedChanges = false;

                inputs.forEach(input => {
                    const originalValue = input.dataset.originalValue || '';
                    const currentValue = input.type === 'checkbox' ? input.checked : input.value;

                    if (String(currentValue) !== String(originalValue)) {
                        hasUnsavedChanges = true;
                    }
                });

                // Zahlungsbutton prüfen
                const invoiceBtn = document.getElementById('invoiceBtn');
                if (invoiceBtn) {
                    const originalValue = invoiceBtn.dataset.originalValue || '0';
                    const currentValue = invoiceBtn.getAttribute('data-value') || '0';

                    if (originalValue !== currentValue) {
                        hasUnsavedChanges = true;
                    }
                }

                console.log('Form changes detected:', hasUnsavedChanges);
            }

            // Funktion für sichere Navigation (gleich wie Swipe-Geste)
            function safeNavigateBack() {
                console.log('🔙 safeNavigateBack() aufgerufen (wie Swipe-Geste)');
                console.log('  - hasUnsavedChanges:', hasUnsavedChanges);

                // Bei ungespeicherten Änderungen Modal zeigen
                if (hasUnsavedChanges) {
                    console.log('⚠️ Ungespeicherte Änderungen - zeige Modal');
                    showSaveModal();
                    return;
                }

                console.log('✅ Navigiere zurück...');
                performNavigation();
            }

            function performNavigation() {
                console.log('Performing navigation...');

                // Browser-History oder zur Reservierungsliste
                if (document.referrer && document.referrer.includes('/wci/')) {
                    window.history.back();
                } else {
                    window.location.href = 'reservierungen.html';
                }
            }

            // Touch-Events nur für Touch-Geräte aktivieren
            if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
                document.addEventListener('touchstart', function (e) {
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                }, { passive: true });

                document.addEventListener('touchmove', function (e) {
                    const currentX = e.changedTouches[0].screenX;
                    const currentY = e.changedTouches[0].screenY;
                    const deltaX = currentX - touchStartX;
                    const deltaY = currentY - touchStartY;

                    // Nur bei horizontalem Swipe nach rechts und minimaler vertikaler Bewegung
                    if (deltaX > 30 && Math.abs(deltaY) < 50) {

                        // Swipe-Indikator erstellen (falls noch nicht vorhanden)
                        if (!swipeIndicator) {
                            swipeIndicator = document.createElement('div');
                            swipeIndicator.style.cssText = `
                                position: fixed;
                                top: 50%;
                                right: 20px;
                                transform: translateY(-50%);
                                background: rgba(46, 204, 113, 0.9);
                                color: white;
                                padding: 12px 18px;
                                border-radius: 25px;
                                font-size: 14px;
                                font-weight: bold;
                                z-index: 10000;
                                pointer-events: none;
                                transition: all 0.2s ease;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            `;
                            swipeIndicator.innerHTML = hasUnsavedChanges
                                ? 'Änderungen? <span style="font-size: 18px;">→</span>'
                                : 'Zurück <span style="font-size: 18px;">→</span>';
                            document.body.appendChild(swipeIndicator);
                        }

                        // Opacity und Skalierung basierend auf Swipe-Distanz
                        const progress = Math.min(Math.abs(deltaX) / 100, 1);
                        const opacity = Math.max(0.3, progress);
                        const scale = 0.8 + (progress * 0.2);

                        swipeIndicator.style.opacity = opacity;
                        swipeIndicator.style.transform = `translateY(-50%) scale(${scale})`;

                        // Verhindere Scroll während Swipe
                        if (progress > 0.3) {
                            e.preventDefault();
                        }
                    }
                }, { passive: false });

                document.addEventListener('touchend', function (e) {
                    touchEndX = e.changedTouches[0].screenX;
                    touchEndY = e.changedTouches[0].screenY;

                    // Indikator entfernen
                    if (swipeIndicator) {
                        swipeIndicator.style.opacity = '0';
                        swipeIndicator.style.transform = 'translateY(-50%) scale(0.5)';
                        setTimeout(() => {
                            if (swipeIndicator) {
                                swipeIndicator.remove();
                                swipeIndicator = null;
                            }
                        }, 200);
                    }

                    // Swipe-Geste auswerten
                    handleSwipeGesture();
                }, { passive: true });
            }

            function handleSwipeGesture() {
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const absDeltaX = Math.abs(deltaX);
                const absDeltaY = Math.abs(deltaY);
                const minSwipeDistance = window.screen.width * 0.2; // 20% der Bildschirmbreite

                // Mindest-Swipe-Distanz (20% Bildschirmbreite) und horizontaler Swipe dominiert
                if (absDeltaX > minSwipeDistance && absDeltaX > absDeltaY * 1.5) {

                    // Swipe nach rechts = zurück zur vorherigen Seite (mit Speicher-Abfrage)
                    if (deltaX > 0) {
                        console.log('Swipe right detected - checking for unsaved changes...');
                        safeNavigateBack();
                    }
                }
            }

            // Connection Status für diese Seite initialisieren
            document.addEventListener('DOMContentLoaded', function () {
                const indicator = document.getElementById('connection-indicator');
                if (indicator && window.connectionMonitor) {
                    // Initial update
                    if (window.updateConnectionStatus) {
                        window.updateConnectionStatus();
                    }
                }

                // Change Tracking einrichten
                setupChangeTracking();

                console.log('✅ ReservationDetails page initialized');
                console.log('✅ Swipe navigation with save prompt enabled for touch devices');
            });

            // Browser-Navigation abfangen - zeigt Modal bei ungespeicherten Änderungen
            window.addEventListener('beforeunload', function (e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = 'Sie haben ungespeicherte Änderungen. Möchten Sie die Seite wirklich verlassen?';
                    return e.returnValue;
                }
            });
        </script>
</body>

</html>